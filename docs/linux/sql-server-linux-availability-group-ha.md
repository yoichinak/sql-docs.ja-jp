---
title: 可用性グループの展開パターン - SQL Server on Linux
description: Linux サーバー上の SQL Server Always On 可用性グループに対してサポートされているデプロイ構成について説明します。
ms.custom: seo-lt-2019
ms.date: 04/17/2019
ms.prod: sql
ms.technology: linux
ms.topic: conceptual
ms.assetid: edd75f68-dc62-4479-a596-57ce8ad632e5
author: VanMSFT
ms.author: vanto
ms.reviewer: vanto
ms.openlocfilehash: 8c48facb150d527cc1c03c0d5cd9ca0849a889f0
ms.sourcegitcommit: 22e97435c8b692f7612c4a6d3fe9e9baeaecbb94
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/27/2020
ms.locfileid: "92679277"
---
# <a name="high-availability-and-data-protection-for-availability-group-configurations"></a>可用性グループ構成の高可用性とデータ保護

[!INCLUDE [SQL Server - Linux](../includes/applies-to-version/sql-linux.md)]

この記事では、Linux サーバー上の SQL Server Always On 可用性グループに対してサポートされているデプロイ構成について説明します。 可用性グループでは、高可用性とデータ保護がサポートされています。 フェールオーバー後の自動障害検出、自動フェールオーバー、および透過的再接続により、高可用性が提供されます。 同期されるレプリカにより、データ保護が提供されます。 

Windows Server フェールオーバー クラスター (WSFC) では、高可用性のための一般的な構成で、2 つの同期レプリカと 3 番目のサーバーまたはファイル共有を使用して、クォーラムが提供されます。 ファイル共有監視では、可用性グループの構成 (たとえば、同期の状態や、レプリカのロール) が検証されます。 この構成によって、フェールオーバー ターゲットとして選択されたセカンダリ レプリカに、最新のデータと可用性グループの構成変更が反映されます。 

WSFC では、可用性グループ レプリカとファイル共有監視との間のフェールオーバーを判別するために、構成メタデータが同期されます。 可用性グループが WSFC 上にない場合、SQL Server インスタンスにより構成メタデータが master データベースに格納されます。

たとえば、Linux クラスター上の可用性グループで `CLUSTER_TYPE = EXTERNAL` が指定されているとします。 フェールオーバーを判別するための WSFC はありません。 その場合、構成メタデータは SQL Server インスタンスによって管理および保守されます。 このクラスターにはミラーリング監視サーバーがないため、構成状態のメタデータを格納するには 3 つ目の SQL Server インスタンスが必要です。 3 つの SQL Server インスタンスがすべて揃うことで、クラスターの分散メタデータ ストレージが提供されます。 

クラスター マネージャーは、可用性グループ内の SQL Server インスタンスに対してクエリを実行し、高可用性を維持するためにフェールオーバーを調整できます。 Linux クラスターでは、Pacemaker がクラスター マネージャーとなります。 

SQL Server 2017 CU 1 では、`CLUSTER_TYPE = EXTERNAL` が指定された可用性グループに対して、2 つの同期レプリカと 1 つの構成専用レプリカに対応した高可用性が提供されます。 構成専用レプリカは、SQL Server 2017 CU1 以降の任意のエディション (SQL Server Express エディションを含む) でホストできます。 構成専用レプリカには、master データベース内の可用性グループに関する構成情報が保持されますが、可用性グループ内のユーザー データベースは含まれません。 

## <a name="how-the-configuration-affects-default-resource-settings"></a>構成が既定のリソース設定に与える影響

SQL Server 2017 では、クラスター リソース設定 `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` が導入されました。 この設定により、プライマリ レプリカで各トランザクションがコミットされる前に、指定された数のセカンダリ レプリカでトランザクション データがログに書き込まれるようになります。 外部クラスター マネージャーを使用する場合、この設定は高可用性とデータ保護の両方に影響を及ぼします。 この設定の既定値は、クラスター リソースが作成された時点のアーキテクチャによって決まります。 SQL Server リソース エージェント (`mssql-server-ha`) をインストールし、可用性グループのクラスター リソースを作成すると、クラスター マネージャーによって可用性グループの構成が検出され、それに応じて `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` が設定されます。 

構成でサポートされている場合、リソース エージェント パラメーター `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` は高可用性とデータ保護を提供する値に設定されます。 詳細については、「[Pacemaker 用の SQL Server リソース エージェントについて理解する](#pacemakerNotify)」を参照してください。

以下のセクションでは、クラスター リソースの既定の動作について説明します。 

高可用性、データ保護、および読み取りスケールの特定のビジネス要件を満たすように、可用性グループの設計を選択してください。

次の各構成を見ながら、可用性グループの設計パターンと、各パターンの機能について説明していきます。 これらの設計パターンは、高可用性ソリューション用に `CLUSTER_TYPE = EXTERNAL` が指定された可用性グループに対して適用されます。 

- **3 つの同期レプリカ**
- **2 つの同期レプリカ**
- **2 つの同期レプリカと 1 つの構成専用レプリカ**

<a name="threeSynch"></a>

## <a name="three-synchronous-replicas"></a>3 つの同期レプリカ

この構成は、3 つの同期レプリカで構成されます。 既定では、高可用性とデータ保護が提供されます。 また、読み取りスケールを提供することもできます。

![3 つのレプリカ][3]

3 つの同期レプリカを持つ可用性グループでは、読み取りスケール、高可用性、およびデータ保護を提供できます。 次の表は、可用性の動作について説明したものです。 

|可用性の動作 |読み取りスケール|高可用性と </br> データの保護 | データ保護|
|:---|---|---|---|
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 |1<sup>\*</sup>|2|
|プライマリ停止 |自動フェールオーバー。 新しいプライマリは読み取り/書き込みです。 |自動フェールオーバー。 新しいプライマリは読み取り/書き込みです。 |自動フェールオーバー。 前のプライマリが復旧してセカンダリとして可用性グループに参加するまで、新しいプライマリはユーザー トランザクション用には使用できません。 |
|1 つのセカンダリ レプリカ停止  | プライマリは読み取り/書き込みです。 プライマリに障害が発生した場合、自動フェールオーバーは行われません。 |プライマリは読み取り/書き込みです。 プライマリにも障害が発生した場合、自動フェールオーバーは行われません。 | プライマリはユーザー トランザクション用には使用できません。 |

<sup>\*</sup> 既定

<a name="twoSynch"></a>

## <a name="two-synchronous-replicas"></a>2 つの同期レプリカ

この構成では、データ保護が提供できます。 他の可用性グループ構成と同じく、読み取りスケールを有効にすることもできます。 2 つの同期レプリカの構成では、自動高可用性は提供されません。 2 つのレプリカの構成は SQL Server 2017 RTM にのみ適用され、SQL Server 2017 の上位バージョン (CU1 以降) ではサポートされなくなりました。

![2 つの同期レプリカ][1]

2 つの同期レプリカを持つ可用性グループでは、読み取りスケールとデータ保護が提供されます。 次の表は、可用性の動作について説明したものです。 

|可用性の動作 |読み取りスケール |データ保護|
|:---|---|---|
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>\*</sup>|1|
|プライマリ停止 | 手動フェールオーバー。 データが失われる可能性があります。 新しいプライマリは読み取り/書き込みです。| 自動フェールオーバー。 前のプライマリが復旧してセカンダリとして可用性グループに参加するまで、新しいプライマリはユーザー トランザクション用には使用できません。|
|1 つのセカンダリ レプリカ停止  |プライマリは読み取り/書き込みであり、データが失われる可能性があります。 |プライマリは、セカンダリが復旧するまではユーザー トランザクション用に使用できません。|

<sup>\*</sup> 既定

<a name = "configOnly"></a>

## <a name="two-synchronous-replicas-and-a-configuration-only-replica"></a>2 つの同期レプリカと 1 つの構成専用レプリカ

2 つ (以上) の同期レプリカと構成専用レプリカを持つ可用性グループでは、データ保護が提供され、高可用性を提供することもできます。 次の図は、このアーキテクチャを表したものです。

![構成専用可用性グループ][2]

1. セカンダリ レプリカへのユーザー データの同期レプリケーションです。 これには、可用性グループの構成メタデータも含まれます。
2. 可用性グループの構成メタデータの同期レプリケーションです。 ユーザー データは含まれません。

可用性グループの図では、プライマリ レプリカが、セカンダリ レプリカと構成専用レプリカの両方に構成データをプッシュしています。 また、セカンダリ レプリカはユーザー データも受け取ります。 構成専用レプリカは、ユーザー データを受信しません。 セカンダリ レプリカは同期可用性モードになります。 構成専用レプリカには、可用性グループ内のデータベースは含まれません (可用性グループに関するメタデータのみ)。 構成専用レプリカ上の構成データは同期的にコミットされます。

> [!NOTE]
> 構成専用レプリカを使う可用性グループは、SQL Server 2017 CU1 向けに新しく追加されたものです。 可用性グループ内のすべての SQL Server インスタンスは、SQL Server 2017 CU1 以降である必要があります。 

`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` の既定値は 0 です。 次の表は、可用性の動作について説明したものです。 

|可用性の動作 |高可用性と </br> データの保護 | データ保護|
|:---|---|---|
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>\*</sup>|1|
|プライマリ停止 | 自動フェールオーバー。 新しいプライマリは読み取り/書き込みです。 | 自動フェールオーバー。 新しいプライマリはユーザー トランザクション用には使用できません。 |
|セカンダリ レプリカ停止 | プライマリは読み取り/書き込みで、データが失われる可能性があります (プライマリで障害が発生し、復旧できない場合)。 プライマリにも障害が発生した場合、自動フェールオーバーは行われません。 | プライマリはユーザー トランザクション用には使用できません。 プライマリでも障害が発生した場合、フェールオーバー先となるレプリカはありません。 |
|構成専用レプリカ停止 | プライマリは読み取り/書き込みです。 プライマリにも障害が発生した場合、自動フェールオーバーは行われません。 | プライマリは読み取り/書き込みです。 プライマリにも障害が発生した場合、自動フェールオーバーは行われません。 |
|同期セカンダリ + 構成専用レプリカ停止| プライマリはユーザー トランザクション用には使用できません。 自動フェールオーバーは行われません。 | プライマリはユーザー トランザクション用には使用できません。 プライマリでも障害が発生した場合、フェールオーバー先となるレプリカはありません。 |

<sup>\*</sup> 既定

> [!NOTE]
> 構成専用レプリカをホストする SQL Server インスタンスでは、他のデータベースをホストすることもできます。 また、複数の可用性グループの構成専用データベースとして参加することもできます。 

## <a name="requirements"></a>必要条件

- 構成専用レプリカを持つ可用性グループ内のすべてのレプリカは、SQL Server 2017 CU 1 以降である必要があります。
- 構成専用レプリカは、SQL Server の任意のエディション (SQL Server Express を含む) でホストできます。 
- 可用性グループには、プライマリ レプリカに加えて、少なくとも 1 つのセカンダリ レプリカが必要です。
- 構成専用レプリカは、SQL Server インスタンスごとのレプリカの最大数にはカウントされません。 SQL Server Standard Edition では最大 3 個のレプリカを使用でき、SQL Server Enterprise Edition では最大 9 個を使用できます。

## <a name="considerations"></a>考慮事項

- 構成専用レプリカは可用性グループごとに 1 つずつしか使用できません。 
- 構成専用レプリカをプライマリ レプリカにすることはできません。
- 構成専用レプリカの可用性モードを変更することはできません。 構成専用レプリカを同期または非同期のセカンダリ レプリカに変更するには、構成専用レプリカを削除し、必要な可用性モードのセカンダリ レプリカを追加します。 
- 構成専用レプリカは、可用性グループのメタデータと同期されます。 ユーザー データはありません。 
- 1 つのプライマリ レプリカと 1 つの構成専用レプリカがあり、セカンダリ レプリカがない可用性グループは有効ではありません。 
- SQL Server Express Edition のインスタンスに可用性グループを作成することはできません。 

<a name="pacemakerNotify"></a>

## <a name="understand-sql-server-resource-agent-for-pacemaker"></a>Pacemaker 用の SQL Server リソース エージェントについて理解する

SQL Server 2017 CTP 1.4 では、`sys.availability_groups` に `sequence_number` が追加されました。これにより、プライマリ レプリカに対するセカンダリ レプリカの最新度を Pacemaker で確認できるようになりました。 `sequence_number` は、ローカルの可用性グループ レプリカの最新度を表す、単調増加 BIGINT です。 Pacemaker により、可用性グループの構成が変更されるたびに `sequence_number` が更新されます。 構成変更の例としては、フェールオーバー、レプリカの追加、削除などがあります。 この数はプライマリ上で更新され、セカンダリ レプリカにレプリケートされます。 そのため、最新の構成を保持しているセカンダリ レプリカでは、シーケンス番号がプライマリと同じになります。 

レプリカをプライマリに昇格することが Pacemaker により決定されると、まずすべてのレプリカに " *昇格前* " の通知を送られます。 レプリカによりシーケンス番号が返されます。 次に、Pacemaker が実際にレプリカをプライマリに昇格しようとする際、レプリカは、そのシーケンス番号がすべてのシーケンス番号の最大値である場合にのみ自身を昇格させます。 自身のシーケンス番号が最大のシーケンス番号と一致しない場合、レプリカは昇格操作を拒否します。 この方法により、最大のシーケンス番号を持つレプリカだけがプライマリに昇格できるようになるため、データの損失が回避されます。 

このプロセスでは、昇格の対象となるレプリカのうち少なくとも 1 つが、以前のプライマリと同じシーケンス番号を持っていることが要件となります。 Pacemaker リソース エージェントの既定では、少なくとも 1 つの同期セカンダリ レプリカが最新の状態であり、自動フェールオーバーのターゲットとして使用できるように、`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` が設定されます。 各監視アクションでは、`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` の値が計算 (および、必要に応じて更新) されます。 `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` の値は、"同期レプリカの数" を 2 で除算した値です。 フェールオーバーの際、リソース エージェントにより、(`total number of replicas` - `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` のレプリカ数が) 昇格前通知に応答することが要求されます。 `sequence_number` が最大であるレプリカがプライマリに昇格されます。 

たとえば、3 つの同期レプリカ (1 つのプライマリ レプリカと 2 つの同期セカンダリ レプリカ) を持つ可用性グループがあるとします。

- `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` は 1 です (3 / 2 -> 1)。

- 昇格前アクションに応答しなければならないレプリカの数は 2 です (3 - 1 = 2)。 

このシナリオの場合、フェールオーバーがトリガーされるには、2 つのレプリカが応答する必要があります。 プライマリ レプリカの停止後に自動フェールオーバーが正常に行われるには、両方のセカンダリ レプリカが最新の状態であり、昇格前の通知に応答する必要があります。 オンラインで同期されている場合、両者のシーケンス番号は同じになります。 可用性グループは、そのうちの 1 つを昇格させます。 1 つのセカンダリ レプリカのみが昇格前アクションに応答した場合、応答したセカンダリのシーケンス番号が最大であることをリソース エージェントが確認できず、フェールオーバーはトリガーされません。

> [!IMPORTANT]
> `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` が 0 の場合、データ損失のリスクがあります。 プライマリ レプリカの停止中、リソース エージェントによりフェールオーバーは自動的にトリガーされません。 プライマリが復旧するまで待つか、`FORCE_FAILOVER_ALLOW_DATA_LOSS` を使用して手動でフェールオーバーできます。

既定の動作をオーバーライドし、可用性グループ リソースが `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` を自動的に設定しないようにすることもできます。

次の例のスクリプトは、`<**ag1**>` という名前の可用性グループで `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` を 0 に設定します。 実行する前に、`<**ag1**>` を実際の可用性グループの名前に置き換えます。

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=0
```

既定値に戻すには、可用性グループの構成に基づいて、次のコマンドを実行します。

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=
```

> [!NOTE]
> 上記のコマンドを実行すると、プライマリは一時的にセカンダリに降格され、再度昇格されます。 リソースが更新されると、すべてのレプリカが停止して再起動します。 `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` の新しい値は、直ちにではなく、レプリカが再起動されたとき設定されます。

## <a name="see-also"></a>関連項目

[Linux 上の可用性グループ](sql-server-linux-availability-group-overview.md)

<!--Image references-->
[1]: ./media/sql-server-linux-availability-group-ha/1-read-scale-out.png
[2]: ./media/sql-server-linux-availability-group-ha/2-configuration-only.png
[3]: ./media/sql-server-linux-availability-group-ha/3-three-replica.png
[4]: ./media/sql-server-linux-availability-group-ha/configuration-only-example.png
