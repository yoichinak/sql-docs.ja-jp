---
title: バックアップと復元
description: 並列データウェアハウス (PDW) でのデータのバックアップと復元のしくみについて説明します。 バックアップ操作と復元操作は、ディザスターリカバリーのために使用されます。 バックアップと復元を使用すると、1つのアプライアンスから別のアプライアンスにデータベースをコピーすることもできます。
author: mzaman1
ms.prod: sql
ms.technology: data-warehouse
ms.topic: conceptual
ms.date: 01/19/2019
ms.author: murshedz
ms.reviewer: martinle
ms.custom: seo-dt-2019
ms.openlocfilehash: e7f106e462d3d1bb7848b15523ef3d3f7feed2a1
ms.sourcegitcommit: 7345e4f05d6c06e1bcd73747a4a47873b3f3251f
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/24/2020
ms.locfileid: "88767211"
---
# <a name="backup-and-restore"></a>バックアップと復元

並列データウェアハウス (PDW) でのデータのバックアップと復元のしくみについて説明します。 バックアップ操作と復元操作は、ディザスターリカバリーのために使用されます。 バックアップと復元を使用すると、1つのアプライアンスから別のアプライアンスにデータベースをコピーすることもできます。  
    
## <a name="backup-and-restore-basics"></a><a name="BackupRestoreBasics"></a>バックアップと復元の基本

PDW *データベースバックアップ* は、形式で格納されたアプライアンスデータベースのコピーであり、元のデータベースをアプライアンスに復元するために使用できます。  
  
PDW データベースバックアップは、 [BACKUP database](../t-sql/statements/backup-transact-sql.md?view=aps-pdw-2016) t-sql ステートメントを使用して作成され、 [RESTORE database](../t-sql/statements/restore-statements-transact-sql.md?view=aps-pdw-2016) ステートメントで使用するように書式設定されます。他の目的では使用できません。 バックアップは、同じ数またはより多くのコンピューティングノードを持つアプライアンスにのみ復元できます。  
  
<!-- MISSING LINKS
The [master database](master-database.md) is a SMP SQL Server database. It is backed up with the BACKUP DATABASE statement. To restore master, use the [Restore the Master Database](configuration-manager-restore-master-database.md) page of the Configuration Manager tool.  
-->
  
PDW では、SQL Server バックアップテクノロジを使用して、アプライアンスデータベースのバックアップと復元を行います。 SQL Server バックアップオプションは、バックアップの圧縮を使用するように事前構成されています。 圧縮、チェックサム、ブロック サイズ、バッファー カウントなど、バックアップ オプションを設定することはできません。  
  
データベースバックアップは、お客様の顧客ネットワークに存在する1つまたは複数のバックアップサーバーに格納されます。  PDW は、ユーザーデータベースのバックアップを、コンピューティングノードから1つのバックアップサーバーに直接書き込み、ユーザーデータベースのバックアップを直接バックアップサーバーから計算ノードに復元します。  
  
バックアップは、Windows ファイルシステムの一連のファイルとしてバックアップサーバーに格納されます。 PDW データベースのバックアップは、PDW にのみ復元できます。 ただし、標準の Windows ファイルバックアッププロセスを使用して、バックアップサーバーから別の場所にデータベースのバックアップをアーカイブすることができます。 バックアップサーバーの詳細については、「 [バックアップサーバーの取得と構成](acquire-and-configure-backup-server.md)」を参照してください。  
  
## <a name="database-backup-types"></a><a name="BackupTypes"></a>データベースバックアップの種類

バックアップを必要とするデータには、ユーザーデータベースとシステムデータベース (master データベースなど) の2種類があります。 PDW では、トランザクションログはバックアップされません。  
  
データベースの完全バックアップは、PDW データベース全体のバックアップです。 これは、既定のバックアップの種類です。 ユーザーデータベースの完全バックアップには、データベースユーザーとデータベースロールが含まれます。 Master のバックアップには、ログインが含まれます。  
  
差分バックアップには、前回の完全バックアップ以降のすべての変更が含まれます。 通常、差分バックアップは完全バックアップよりも短時間で完了します。完全バックアップよりも頻繁に実行できます。 複数の差分バックアップが同じ完全バックアップに基づいている場合、各差分には前の差分のすべての変更が含まれます。  
  
たとえば、1日に1回完全バックアップを作成し、差分バックアップを毎日作成することができます。 ユーザーデータベースを復元するには、完全バックアップと最後の差分 (存在する場合) を復元する必要があります。  
  
差分バックアップは、ユーザーデータベースに対してのみサポートされます。 Master のバックアップは常に完全バックアップです。  
  
アプライアンス全体をバックアップするには、すべてのユーザーデータベースのバックアップと、master データベースのバックアップを実行する必要があります。  
  
## <a name="database-backup-process"></a><a name="BackupProc"></a>データベースのバックアッププロセス

次の図は、データベースバックアップ中のデータフローを示しています。  
  
![PDW のバックアッププロセス](media/backup-process.png "PDW のバックアッププロセス")  
  
バックアッププロセスは次のように機能します。  
  
1.  ユーザーがバックアップデータベースの tsql ステートメントをコントロールノードに送信します。  
  
    -   バックアップは、完全バックアップまたは差分バックアップのいずれかです。  
  
2.  ユーザーデータベースの場合、コントロールノード (MPP エンジン) は、分散クエリプランを作成して、データベースの並列バックアップを実行します。  
  
3.  バックアップに関連する各ノードは、SQL Server バックアップ機能を使用してバックアップファイルをバックアップサーバーにコピーします。  
  
    -   関連する各ノードは、1つのバックアップファイルをバックアップサーバーにコピーします。  
  
    -   ユーザーデータベースのバックアップ (完全または差分) には、各コンピューティングノードに格納されているデータベースの部分のバックアップと、データベースユーザーとデータベースロールのバックアップが含まれます。  
  
4.  アプライアンスは、InfiniBand ネットワークを使用してバックアップを並行して実行します。  
  
    -   PDW は、完全バックアップと差分バックアップを並行して実行します。 ただし、複数のデータベースバックアップを同時に実行することはできません。 各バックアップ要求は、以前に送信されたバックアップが終了するまで待機する必要があります。  
  
    -   Master データベースのバックアップでは、コントロールノードからのデータのみがバックアップされます。 このバックアップの種類は、順次実行されます。  
  
5.  PDW データベースバックアップは、アプライアンスの外部にあるディレクトリに格納されているファイルのグループです。 ディレクトリ名は、ネットワークパスとディレクトリ名として指定されます。 ディレクトリにローカルパスを指定することはできません。また、このディレクトリをアプライアンス上に配置することもできません。  
  
6.  バックアップが完了したら、必要に応じて、Windows ファイルシステムを使用して、バックアップディレクトリを別の場所にコピーできます。  
  
    -   バックアップを復元できるのは、計算ノード数が等しいかそれより多い PDW アプライアンスのみです。  
  
    -   復元を実行する前に、バックアップの名前を変更することはできません。 バックアップディレクトリの名前は、バックアップの元の名前と同じ名前にする必要があります。 バックアップの元の名前は、バックアップディレクトリ内の backup.xml ファイルにあります。 データベースを別の名前に復元するには、restore コマンドで新しい名前を指定します。 (例: `RESTORE DATABASE MyDB1 FROM DISK = ꞌ\\10.192.10.10\backups\MyDB2ꞌ`)。  
  
## <a name="database-restore-modes"></a><a name="RestoreModes"></a>データベースの復元モード

データベースの完全復元では、データベースバックアップのデータを使用して PDW データベースが再作成されます。 データベースの復元を実行するには、最初に完全バックアップを復元してから、必要に応じて1つの差分バックアップを復元します。 データベースの復元には、データベースユーザーとデータベースロールが含まれます。  
  
ヘッダーのみの復元では、データベースのヘッダー情報が返されます。 アプライアンスにデータを復元することはありません。  
  
アプライアンスの復元とは、アプライアンス全体を復元することです。 これには、すべてのユーザーデータベースと master データベースの復元が含まれます。  
  
## <a name="restore-process"></a><a name="RestoreProc"></a>復元プロセス

次の図は、データベースの復元中のデータフローを示しています。  
  
![復元プロセス](media/restore-process.png "復元プロセス")  
  
## <a name="restoring-to-an-appliance-with-the-same-number-of-compute-nodes"></a>同じ数のコンピューティングノードを持つアプライアンスに復元する * *  
  
データを復元すると、アプライアンスによって、ソースアプライアンスと宛先アプライアンスのコンピューティングノードの数が検出されます。 両方のアプライアンスに同じ数のコンピューティングノードがある場合、復元プロセスは次のように動作します。  
  
1.  復元するデータベースバックアップは、アプライアンス以外のバックアップサーバー上の Windows ファイル共有で使用できます。 最適なパフォーマンスを得るために、このサーバーはアプライアンス InfiniBand ネットワークに接続されています。  
  
2.  ユーザーは、 [RESTORE DATABASE](../t-sql/statements/restore-statements-transact-sql.md?view=aps-pdw-2016) tsql ステートメントをコントロールノードに送信します。  
  
    -   復元は、完全復元またはヘッダー復元のいずれかです。 完全復元では、完全バックアップが復元され、必要に応じて差分バックアップが復元されます。  
  
3.  コントロールノード (MPP エンジン) は、並列データベース復元を実行するための分散クエリプランを作成します。  
  
    -   SQL ServerPDW は、ユーザーデータベースの復元を並行して実行します。 ただし、複数のデータベースのバックアップと復元は同時に実行されません。 MPP エンジンは、各 restore ステートメントをキューに格納します。以前に送信されたバックアップと復元要求が終了するまで待機する必要があります。  
  
    -   Master データベースの復元では、データはコントロールノードにのみ復元されます。復元は順次実行されます。  
  
    -   ヘッダー情報の復元は簡単な操作であり、コンピューティングノードまたは制御ノードにデータを復元することはありません。 代わりに、制御ノードは結果をクエリ出力として返します。  
  
4.  バックアップファイルは、通常、アプライアンス InfiniBand ネットワークを経由して、適切なコンピューティングノードに並列的にコピーされます。  
  
5.  各コンピューティングノードは、ユーザーデータベースの一部を復元します。 復元が正常に完了しなかった場合は、すべてのデータベースが削除され、復元は正常に完了しません。  
  
## <a name="restoring-to-an-appliance-with-a-larger-number-of-compute-nodes"></a>より多くの計算ノードを備えたアプライアンスへの復元  
  
より多くの計算ノードを備えたアプライアンスにバックアップを復元すると、計算ノードの数に比例して、割り当てられるデータベースのサイズが大きくなります。  
  
たとえば、2ノードアプライアンス (ノードあたり 30 GB) から6ノードアプライアンスに 60 GB のデータベースを復元する場合、SQL Server PDW は6ノードのアプライアンスに 180 GB のデータベース (ノードあたり 30 GB のノード) を作成します。 では、ソース構成と一致するように、最初にデータベースを2つのノードに復元した後、すべての6ノードにデータを再配布 SQL Server PDW ます。  
  
再配布後、各コンピューティングノードには、小さいソースアプライアンス上の各コンピューティングノードよりも少ない実際のデータと空き領域が含まれます。 追加の領域を使用して、データベースにデータを追加します。 復元されたデータベースのサイズが必要以上に大きい場合は、 [ALTER database](../t-sql/statements/alter-database-transact-sql.md?tabs=sqlpdw) を使用してデータベースファイルのサイズを縮小できます。  
  
## <a name="related-tasks"></a>Related Tasks  
  
|バックアップと復元のタスク|説明|  
|---------------------------|---------------|  
|サーバーをバックアップサーバーとして準備します。|[バックアップ サーバーの取得と構成](acquire-and-configure-backup-server.md)|  
|データベースをバックアップします。|[BACKUP DATABASE](../t-sql/statements/backup-transact-sql.md?view=aps-pdw-2016)|  
|データベースを復元します。|[データベースの復元](../t-sql/statements/restore-statements-transact-sql.md?view=aps-pdw-2016)|    

<!-- MISSING LINKS

|Create a disaster recovery plan.|[Create a Disaster Recovery Plan](create-disaster-recovery-plan.md)|
|Restore the master database.|To restore the master database, use the [Restore the master database](configuration-manager-restore-master-database.md) page in the Configuration Manager tool.| 
|Copy a database from one appliance to another appliance.|[Copy a PDW database to another appliance](copy-pdw-database-to-another-appliance.md).|  
|Monitor backups and restores.|[Monitor backups and restores](monitor-backup-and-restore.md)|  

-->
