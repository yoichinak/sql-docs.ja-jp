---
title: データベース エンジン チューニング アドバイザーの起動および使用 | Microsoft Docs
description: SQL Server でデータベース エンジン チューニング アドバイザーを起動し、使用してワークロードを作成し、データベースを調整し、XML 入力ファイルを作成する方法について説明します。
ms.custom: ''
ms.date: 01/09/2017
ms.prod: sql
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
f1_keywords:
- sql13.dta.workload.f1
- sql13.dta.general.f1
- sql13.dta.advancedtuningoptions.f1
- sql13.dta.tuningoptions.f1
- sql13.dta.progress.f1
- sql13.dta.options.f1
helpviewer_keywords:
- Database Engine Tuning Advisor [SQL Server], starting
ms.assetid: a4e3226a-3917-4ec8-bdf0-472879d231c9
author: julieMSFT
ms.author: jrasnick
ms.openlocfilehash: 68e48fb6316b5794d51208b42ab10938b17126dc
ms.sourcegitcommit: 783b35f6478006d654491cb52f6edf108acf2482
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/09/2020
ms.locfileid: "91890751"
---
# <a name="start-and-use-the-database-engine-tuning-advisor"></a>データベース エンジン チューニング アドバイザーの起動および使用
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]
  このトピックでは、 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]でデータベース エンジン チューニング アドバイザーを起動して使用する方法について説明します。 データベースをチューニングした後で結果を表示および操作する方法については、「 [データベース エンジン チューニング アドバイザーからの出力の表示および操作](../../relational-databases/performance/view-and-work-with-the-output-from-the-database-engine-tuning-advisor.md)」を参照してください。  
  
##  <a name="initialize-the-database-engine-tuning-advisor"></a><a name="Initialize"></a> データベース エンジン チューニング アドバイザーを初期化する  
 初回起動時に、 **sysadmin** 固定サーバー ロールのメンバーであるユーザーがデータベース エンジン チューニング アドバイザーを初期化する必要があります。 これは、チューニング操作をサポートするには、いくつかのシステム テーブルを **msdb** データベースに作成する必要があるためです。 また、初期化によって、 **db_owner** 固定データベース ロールのメンバーであるユーザーも自分の所有するデータベースにあるテーブルのワークロードをチューニングできます。  
  
 システム管理者権限を持つユーザーは、次の操作のいずれかを実行する必要があります。  
  
-   データベース エンジン チューニング アドバイザーのグラフィカル ユーザー インターフェイスを使用して、 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]のインスタンスに接続します。 詳細については、このトピックの「 [データベース エンジン チューニング アドバイザーを起動する](#Start) 」を参照してください。  
  
-   **dta** ユーティリティを使用して最初のワークロードをチューニングします。 詳細については、このトピックの「 [dta ユーティリティを使用する](#dta) 」を参照してください。  
  
##  <a name="start-the-database-engine-tuning-advisor"></a><a name="Start"></a> データベース エンジン チューニング アドバイザーを起動する  
 データベース エンジン チューニング アドバイザーのグラフィカル インターフェイス (GUI) は、さまざまなシナリオでのデータベース チューニングに対応するために、いくつかの異なる方法で起動することができます。 データベース エンジン チューニング アドバイザーを起動する方法としては、 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] の **[スタート]** メニューからの操作、 **[ツール]** メニューからの操作、 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] のクエリ エディターからの操作、 [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] の **[ツール]** メニューからの操作があります。 データベース エンジン チューニング アドバイザーを初めて起動すると、 **[サーバーへの接続]** ダイアログ ボックスが表示されます。このダイアログ ボックスで接続先の [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] インスタンスを指定できます。  
  
> [!WARNING]  
>  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] をシングル ユーザー モードで実行している場合は、データベース エンジン チューニング アドバイザーを起動しないでください。 サーバーをシングル ユーザー モードで実行しているときにデータベース エンジン チューニング アドバイザーを起動しようとしても、エラーが返されて、データベース エンジン チューニング アドバイザーは起動しません。 シングル ユーザー モードの詳細については、「 [シングル ユーザー モードでの SQL Server の起動](../../database-engine/configure-windows/start-sql-server-in-single-user-mode.md)」を参照してください。  
  
#### <a name="to-start-database-engine-tuning-advisor-from-the-windows-start-menu"></a>Windows の [スタート] メニューからデータベース エンジン チューニング アドバイザーを起動するには  
  
1.  **[スタート]** ボタンをクリックし、 **[すべてのプログラム]** 、 **[Microsoft SQL Server]** 、 **[パフォーマンス ツール]** の順にポイントし、 **[データベース エンジン チューニング アドバイザー]** をクリックします。  
  
#### <a name="to-start-the-database-engine-tuning-advisor-in-sql-server-management-studio"></a>SQL Server Management Studio からデータベース エンジン チューニング アドバイザーを起動するには  
  
1.  [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] の **[ツール]** メニューで、 **[データベース エンジン チューニング アドバイザー]** をクリックします。  
  
#### <a name="to-start-the-database-engine-tuning-advisor-from-the-sql-server-management-studio-query-editor"></a>SQL Server Management Studio のクエリ エディターからデータベース エンジン チューニング アドバイザーを起動するには  
  
1.  [!INCLUDE[tsql](../../includes/tsql-md.md)] で [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]スクリプト ファイルを開きます。 詳細については、「[クエリおよびテキスト エディター &#40;SQL Server Management Studio&#41;](../../ssms/f1-help/database-engine-query-editor-sql-server-management-studio.md?view=sql-server-ver15)」を参照してください。  
  
2.  [!INCLUDE[tsql](../../includes/tsql-md.md)] スクリプト内のクエリを選択するか、スクリプト全体を選択します。選択範囲を右クリックし、 **[データベース エンジン チューニング アドバイザーでのクエリの分析]** をクリックします。 データベース エンジン チューニング アドバイザー GUI が表示され、そのスクリプトが XML ファイル ワークロードとしてインポートされます。 セッション名とチューニング オプションを指定して、選択した [!INCLUDE[tsql](../../includes/tsql-md.md)] クエリを自分のワークロードとしてチューニングできます。  
  
#### <a name="to-start-the-database-engine-tuning-advisor-in-sql-server-profiler"></a>SQL Server Profiler からデータベース エンジン チューニング アドバイザーを起動するには  
  
1.  SQL Server Profiler の **[ツール]** メニューの **[データベース エンジン チューニング アドバイザー]** をクリックします。  
  
##  <a name="create-a-workload"></a><a name="Create"></a> ワークロードを作成する  
 ワークロードとは、チューニングするデータベースに対して実行する [!INCLUDE[tsql](../../includes/tsql-md.md)] ステートメントのセットです。 データベース エンジン チューニング アドバイザーでは、サーバーのクエリ パフォーマンスを向上させるインデックスやパーティション分割ストラテジを推奨するために、これらのワークロードが分析されます。  
  
 ワークロードを作成するには、次のいずれかの方法を使用します。  
  
-   [クエリ ストア](../../relational-databases/performance/how-query-store-collects-data.md)をワークロードとして指定する。 このようにすることでワークロードを手動で作成する手間が省けます。 詳しくは、「[Tuning Database Using Workload From Query Store](../../relational-databases/performance/tuning-database-using-workload-from-query-store.md)」(クエリ ストアのワークロードを使用してデータベースをチューニングする) をご覧ください。  

      ||  
      |-|  
      |**適用対象**: [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)] 以降。|  

  
-   プラン キャッシュをワークロードとして指定する。 このようにすることでワークロードを手動で作成する手間が省けます。 詳細については、このトピックの「 [データベースをチューニングする](#Tune) 」を参照してください。  
  
-   [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] のクエリ エディター、または使い慣れたテキスト エディターを使用して、 [!INCLUDE[tsql](../../includes/tsql-md.md)] スクリプト ワークロードを手動で作成できます。  
  
-   トレース ファイルまたはトレース テーブル ワークロードを作成するには、 [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] を使用します。  
  
    > [!NOTE]  
    >  ワークロードとしてトレース テーブルを使用する場合、そのテーブルは、データベース エンジン チューニング アドバイザーがチューニングを実行するサーバーと同じサーバー上に存在する必要があります。 別のサーバーにトレース テーブルを作成した場合は、データベース エンジン チューニング アドバイザーでチューニングされているサーバーに移動します。  
  
-   ワークロードは XML 入力ファイルにも埋め込むことができます。XML 入力ファイルでは、各イベントの重みも指定できます。 埋め込まれたワークロードを指定する方法については、このトピックの「 [XML 入力ファイルを作成する](#XMLInput) 」を参照してください。  
  
###  <a name="to-create-transact-sql-script-workloads"></a><a name="SSMS"></a> Transact-SQL スクリプトのワークロードを作成するには  
  
1.  [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]でクエリ エディターを起動します。 詳細については、「[クエリおよびテキスト エディター &#40;SQL Server Management Studio&#41;](../../ssms/f1-help/database-engine-query-editor-sql-server-management-studio.md?view=sql-server-ver15)」を参照してください。  
  
2.  クエリ エディターに [!INCLUDE[tsql](../../includes/tsql-md.md)] スクリプトを入力します。 このスクリプトには、チューニングする 1 つ以上のデータベースに対して実行する一連の [!INCLUDE[tsql](../../includes/tsql-md.md)] ステートメントが含まれている必要があります。  
  
3.  **.sql** 拡張子を付けて、ファイルを保存します。 データベース エンジン チューニング アドバイザーの GUI および **dta** コマンド ライン ユーティリティで、この [!INCLUDE[tsql](../../includes/tsql-md.md)] スクリプトをワークロードとして使用できます。  
  
###  <a name="to-create-trace-file-and-trace-table-workloads"></a><a name="Profiler"></a> トレース ファイル ワークロードおよびトレース テーブル ワークロードを作成するには  
  
1.  次の方法のいずれかを使用して、 [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] を起動します。  
  
    -   **[スタート]** ボタンをクリックし、 **[すべてのプログラム]** 、 **[Microsoft SQL Server]** 、 **[パフォーマンス ツール]** の順にポイントして、 **[SQL Server Profiler]** をクリックします。  
  
    -   [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]で **[ツール]** メニューをクリックし、次に **[SQL Server Profiler]** をクリックします。  
  
2.  次の手順では、[!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] **Tuning** テンプレートを使用して、トレース ファイルまたはトレース テーブルを作成します。  
  
    -   [トレースの作成 &#40;SQL Server Profiler&#41;](../../tools/sql-server-profiler/create-a-trace-sql-server-profiler.md)  
  
    -   [トレース結果のファイルへの保存 &#40;SQL Server Profiler&#41;](../../tools/sql-server-profiler/save-trace-results-to-a-file-sql-server-profiler.md)  
  
         データベース エンジン チューニング アドバイザーでは、ワークロード トレース ファイルはロールオーバー ファイルと見なされます。 ロールオーバー ファイルの詳細については、「 [Limit Trace File and Table Sizes](../../relational-databases/sql-trace/limit-trace-file-and-table-sizes.md)」を参照してください。  
  
    -   [トレース結果のテーブルへの保存 &#40;SQL Server Profiler&#41;](../../tools/sql-server-profiler/save-trace-results-to-a-table-sql-server-profiler.md)  
  
         トレース テーブルをワークロードとして使用する前に、トレースが停止していることを確認します。  
  
 データベース エンジン チューニング アドバイザー用のワークロードをキャプチャするには、SQL Server Profiler の Tuning テンプレートを使用することをお勧めします。  
  
 独自のテンプレートを使用する場合、次のトレース イベントがキャプチャされるようにしてください。  
  
-   **RPC:Completed**  
  
-   **SQL:BatchCompleted**  
  
-   **SP:StmtCompleted**  
  
 これらのトレース イベントの **Starting** バージョンを使用することもできます。 たとえば、 **SQL:BatchStarting**などです。 ただし、これらのトレース イベントの **Completed** バージョンには、 **Duration** 列が含まれているので、データベース エンジン チューニング アドバイザーは、より効率的にワークロードのチューニングを行うことができます。 データベース エンジン チューニング アドバイザーは、他の種類のトレース イベントのチューニングは行いません。 これらのトレース イベントの詳細については、「 [Stored Procedures Event Category](../../relational-databases/event-classes/stored-procedures-event-category.md) 」および「 [TSQL Event Category](../../relational-databases/event-classes/tsql-event-category.md)」を参照してください。 SQL トレース ストアド プロシージャを使用したトレース ファイル ワークロードの作成の詳細については、「[トレースの作成 &#40;Transact-SQL&#41;](../../relational-databases/sql-trace/create-a-trace-transact-sql.md)」を参照してください。  
  
### <a name="trace-file-or-trace-table-workloads-that-contain-the-loginname-data-column"></a>LoginName データ列を含んでいるトレース ファイル ワークロードまたはトレース テーブル ワークロード  
 データベース エンジン チューニング アドバイザーは、チューニング処理の一環としてプラン表示要求を送信します。 **LoginName** データ列が含まれているトレース テーブルまたはトレース ファイルをワークロードとして使用する場合、データベース エンジン チューニング アドバイザーは、 **LoginName**に指定されているユーザーの権限を借用します。 トレースに含まれているステートメントに対してプラン表示を実行し生成するための SHOWPLAN 権限がそのユーザーに許可されていない場合、そのステートメントのチューニングは行われません。  
  
##### <a name="to-avoid-granting-the-showplan-permission-to-each-user-specified-in-the-loginname-column-of-the-trace"></a>トレースの LoginName 列に指定された各ユーザーに SHOWPLAN 権限を許可しないようにするには  
  
1.  トレース ファイル ワークロードまたはトレース テーブル ワークロードをチューニングします。 詳細については、このトピックの「 [データベースをチューニングする](#Tune) 」を参照してください。  
  
2.  権限が不適切だったためにチューニングされなかったステートメントがないかどうか、チューニング ログを確認します。 詳細については、「 [データベース エンジン チューニング アドバイザーからの出力の表示および操作](../../relational-databases/performance/view-and-work-with-the-output-from-the-database-engine-tuning-advisor.md)」を参照してください。  
  
3.  チューニングされなかったイベントから **LoginName** 列を削除することで、新しいワークロードを作成します。チューニングされなかったイベントのみを新しいトレース ファイルまたは新しいトレース テーブルに保存します。 トレースからデータ列を削除する方法の詳細については、「[トレース ファイルに含めるイベントとデータ列の指定 &#40;SQL Server Profiler&#41;](../../tools/sql-server-profiler/specify-events-and-data-columns-for-a-trace-file-sql-server-profiler.md)」または「[既存のトレースの変更 &#40;Transact-SQL&#41;](../../relational-databases/sql-trace/modify-an-existing-trace-transact-sql.md)」を参照してください。  
  
4.  **LoginName** 列が含まれていない新しいワークロードをデータベース エンジン チューニング アドバイザーに再送信します。  
  
 トレースでログイン情報が指定されていないので、データベース エンジン チューニング アドバイザーはこの新しいワークロードをチューニングします。 ステートメントに **LoginName** が含まれていない場合、データベース エンジン チューニング アドバイザーは、チューニング セッションを開始したユーザー ( **sysadmin** 固定サーバー ロールまたは **db_owner** 固定データベース ロールのいずれかのメンバー) の権限を借用してステートメントをチューニングします。  
  
##  <a name="tune-a-database"></a><a name="Tune"></a> データベースをチューニングする  
 データベースをチューニングするには、データベース エンジン チューニング アドバイザーの GUI または **dta** ユーティリティを使用できます。  
  
> [!NOTE]  
>  データベース エンジン チューニング アドバイザーのワークロードとしてトレース テーブルを使用する前に、トレースが停止していることを確認してください。 データベース エンジン チューニング アドバイザーでは、トレース イベントをワークロードとして書き込み中のトレース テーブルには使用できません。  
  
### <a name="use-the-database-engine-tuning-advisor-graphical-user-interface"></a>データベース エンジン チューニング アドバイザーのグラフィカル ユーザー インターフェイスを使用する  
 データベース エンジン チューニング アドバイザーの GUI で、プラン キャッシュ、ワークロード ファイル、またはワークロード テーブルを使用してデータベースをチューニングできます。 データベース エンジン チューニング アドバイザーの GUI を使用して、現在のチューニング セッションの結果および以前のチューニング セッションの結果を簡単に表示できます。 ユーザー インターフェイス オプションの詳細については、後の「 [ユーザー インターフェイスの説明](#UI) 」を参照してください。 データベースのチューニング後の出力を操作する方法については、「 [データベース エンジン チューニング アドバイザーからの出力の表示および操作](../../relational-databases/performance/view-and-work-with-the-output-from-the-database-engine-tuning-advisor.md)」を参照してください。  

####  <a name="to-tune-a-database-by-using-the-query-store"></a><a name="PlanCache"></a> クエリ ストアを使用してデータベースをチューニングするには
詳しくは、「[Tuning Database Using Workload from Query Store](../../relational-databases/performance/tuning-database-using-workload-from-query-store.md)」(クエリ ストアのワークロードを使用してデータベースをチューニングする) をご覧ください。
  
####  <a name="to-tune-a-database-by-using-the-plan-cache"></a><a name="PlanCache"></a> プラン キャッシュを使用してデータベースをチューニングするには  
  
1.  データベース エンジン チューニング アドバイザーを起動し、 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]のインスタンスにログインします。 詳細については、このトピックの「 [データベース エンジン チューニング アドバイザーを起動する](#Start) 」を参照してください。  
  
2.  **[全般]** タブで **[セッション名]** ボックスに名前を入力して、新しいチューニング セッションを作成します。 セッションのチューニングを始める前に、 **[全般]** タブのフィールドを設定する必要があります。 **[チューニング オプション]** タブの設定は、チューニング セッションを開始する前に変更する必要はありません。  
  
3.  ワークロード オプションとして **[プラン キャッシュ]** を選択します。 データベース エンジン チューニング アドバイザーによって、分析に使用される上位 1,000 件のイベントがプラン キャッシュから選択されます。  
  
4.  チューニングする必要のあるデータベースを選択し、必要に応じて、 **[選択したテーブル]** から、各データベースのテーブル (複数可) を選択します。 すべてのデータベースのキャッシュ エントリを含めるには、 **[チューニング オプション]** の **[詳細設定オプション]** をクリックし、 **[すべてのデータベースのプラン キャッシュ イベントを含める]** をオンにします。  
  
5.  チューニング ログを保存するには、 **[チューニング ログを保存する]** をオンにします。 チューニング ログのコピーを保存しない場合は、このチェック ボックスをオフにします。  
  
     セッションを開いて **[進行状況]** タブを選択すると、分析後にチューニング ログを表示できます。  
  
6.  **[チューニング オプション]** タブをクリックし、必要なオプションを選択します。  
  
7.  **[分析の開始]** をクリックします。  
  
     チューニング セッションの開始後にセッションを停止する場合、 **[アクション]** メニューにある次のオプションから 1 つを選択します。  
  
    -   **[分析の停止 (推奨設定を使用)]** を選択すると、チューニング セッションが停止され、この時点までに実行された分析に基づいて、データベース エンジン チューニング アドバイザーで推奨設定を生成するかどうかを決定するように求めるメッセージが表示されます。  
  
    -   **[分析の停止]** を選択すると、推奨設定を生成せずにチューニング セッションを停止します。  
  
> [!NOTE]  
>  データベース エンジン チューニング アドバイザーの一時停止はサポートされていません。 ツールバーの **[分析の停止]** または **[分析の停止 (推奨設定を使用)]** のいずれかをクリックしてからツールバーの **[分析の開始]** をクリックすると、データベース エンジン チューニング アドバイザーは新しいチューニング セッションを開始します。  
  
#### <a name="to-tune-a-database-using-a-workload-file-or-table-as-input"></a>ワークロード ファイルまたはテーブルを入力として使用してデータベースをチューニングするには  
  
1.  解析時に、データベース エンジン チューニング アドバイザーによって追加、削除、または保有を検討するデータベースの機能 (インデックス、インデックス付きビュー、パーティション分割) を決定します。  
  
2.  ワークロードを作成します。 詳細については、このトピックの「 [ワークロードを作成する](#Create) 」を参照してください。  
  
3.  データベース エンジン チューニング アドバイザーを起動し、[!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] のインスタンスにログインします。 詳細については、このトピックの「 [データベース エンジン チューニング アドバイザーを起動する](#Start) 」を参照してください。  
  
4.  **[全般]** タブで **[セッション名]** ボックスに名前を入力して、新しいチューニング セッションを作成します。  
  
5.  **[ワークロード]** で **[ファイル]** または [テーブル] を選択し、該当するボックスにファイルのパスまたはテーブルの名前を入力します。  
  
     テーブルは次の形式で指定します。  
  
    ```  
    database_name.schema_name.table_name  
    ```  
  
     ワークロード ファイルまたはテーブルを検索するには、 **[参照]** をクリックします。 データベース エンジン チューニング アドバイザーでは、ワークロード ファイルがロールオーバー ファイルであることが前提となります。 ロールオーバー ファイルの詳細については、「 [Limit Trace File and Table Sizes](../../relational-databases/sql-trace/limit-trace-file-and-table-sizes.md)」を参照してください。  
  
     ワークロードとしてトレース テーブルを使用する場合、そのテーブルは、データベース エンジン チューニング アドバイザーがチューニングを実行するサーバーと同じサーバー上に存在する必要があります。 異なるサーバー上でトレース テーブルを作成した場合は、そのテーブルをワークロードとして使用する前に、データベース エンジン チューニング アドバイザーがチューニングを実行するサーバーに移す必要があります。  
  
6.  手順 5. で選択したワークロードを実行するデータベースとテーブルを選択します。 テーブルを選択するには、 **[選択したテーブル]** 列の矢印をクリックします。  
  
7.  チューニング ログを保存するには、 **[チューニング ログを保存する]** をオンにします。 チューニング ログのコピーを保存しない場合は、このチェック ボックスをオフにします。  
  
     セッションを開いて **[進行状況]** タブを選択すると、分析後にチューニング ログを表示できます。  
  
8.  **[チューニング オプション]** タブをクリックし、必要なオプションを選択します。  
  
9. ツール バーの **[分析の開始]** ボタンをクリックします。  
  
     チューニング セッションの開始後にセッションを停止する場合、 **[アクション]** メニューにある次のオプションから 1 つを選択します。  
  
    -   **[分析の停止 (推奨設定を使用)]** を選択すると、チューニング セッションが停止され、この時点までに実行された分析に基づいて、データベース エンジン チューニング アドバイザーで推奨設定を生成するかどうかを決定するように求めるメッセージが表示されます。  
  
    -   **[分析の停止]** を選択すると、推奨設定を生成せずにチューニング セッションを停止します。  
  
> [!NOTE]  
>  データベース エンジン チューニング アドバイザーの一時停止はサポートされていません。 ツールバーの **[分析の停止]** または **[分析の停止 (推奨設定を使用)]** のいずれかをクリックしてからツールバーの **[分析の開始]** をクリックすると、データベース エンジン チューニング アドバイザーは新しいチューニング セッションを開始します。  
  
###  <a name="use-the-dta-utility"></a><a name="dta"></a> dta ユーティリティを使用する  
 [dta ユーティリティ](../../tools/dta/dta-utility.md) には、データベースのチューニングに使用できるコマンド プロンプト実行可能ファイルが用意されています。 このファイルにより、バッチ ファイルやスクリプトでデータベース エンジン チューニング アドバイザー機能を使用できるようになります。 **dta** ユーティリティでは、ワークロードとして、プラン キャッシュ エントリ、トレース ファイル、トレース テーブル、および [!INCLUDE[tsql](../../includes/tsql-md.md)] スクリプトが使用されます。 また、データベース エンジン チューニング アドバイザー XML スキーマに準拠する XML 入力も使用されます。このスキーマは、この [Microsoft Web サイト](https://go.microsoft.com/fwlink/?linkid=43100)から入手できます。  
  
 **dta** ユーティリティを使用してワークロードのチューニングを開始する前に、次のことを考慮してください。  
  
-   ワークロードとしてトレース テーブルを使用する場合、そのテーブルは、データベース エンジン チューニング アドバイザーがチューニングを実行するサーバーと同じサーバー上に存在する必要があります。 他のサーバーにトレース テーブルを作成した場合は、トレース テーブルをデータベース エンジン チューニング アドバイザーでチューニングするサーバーに移動してください。  
  
-   データベース エンジン チューニング アドバイザーのワークロードとしてトレース テーブルを使用する前に、トレースが停止していることを確認してください。 データベース エンジン チューニング アドバイザーでは、トレース イベントをワークロードとして書き込み中のトレース テーブルには使用できません。  
  
-   チューニング セッションの実行が予想よりも長く続いている場合、Ctrl キーを押しながら C キーを押してチューニング セッションを停止し、その時点までに **dta** で完了した分析に基づいて推奨設定を作成できます。 推奨設定を生成するかどうかの確認が要求されます。 Ctrl</localizedText> + <localizedText>C</localizedText> キーをもう一度押すと、推奨設定を生成せずにチューニング セッションを停止します。  
  
 **dta** ユーティリティの構文と例の詳細については、「 [dta Utility](../../tools/dta/dta-utility.md)」を参照してください。  
  
#### <a name="to-tune-a-database-by-using-the-plan-cache"></a>プラン キャッシュを使用してデータベースをチューニングするには  
  
1.  **-ip** オプションを指定します。 選択したデータベースの上位 1,000 個のプラン キャッシュ イベントが分析されます。  
  
     コマンド プロンプトで、次のコマンドを入力します。  
  
    ```  
    dta -E -D DatabaseName -ip -s SessionName  
    ```  
  
2.  分析に使用するイベントの数を変更するには、 **-n** オプションを指定します。 次の例では、キャッシュ エントリの数を 2,000 に増やします。  
  
    ```  
    dta -E -D DatabaseName -ip -n 2000-s SessionName1  
    ```  
  
3.  インスタンスのすべてのデータベースのイベントを分析するには、 **-ipf** オプションを指定します。  
  
    ```  
    dta -E -D DatabaseName -ip -ipf -n 2000 -s SessionName2  
    ```  
  
#### <a name="to-tune-a-database-by-using-a-workload-and-dta-utility-default-settings"></a>ワークロードと dta ユーティリティの既定の設定を使用してデータベースをチューニングするには  
  
1.  解析時に、データベース エンジン チューニング アドバイザーによって追加、削除、または保有を検討するデータベースの機能 (インデックス、インデックス付きビュー、パーティション分割) を決定します。  
  
2.  ワークロードを作成します。 詳細については、このトピックの「 [ワークロードを作成する](#Create) 」を参照してください。  
  
3.  コマンド プロンプトで、次のコマンドを入力します。  
  
    ```  
    dta -E -D DatabaseName -if WorkloadFile -s SessionName  
    ```  
  
     このコマンドの `-E` はチューニング セッションで (ログイン ID とパスワードではなく) 信頼関係接続を使用することを指定し、 `-D` はチューニングするデータベースの名前を指定します。 既定では、ユーティリティは、ローカル コンピューター上の [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] の既定のインスタンスに接続します。 (リモート データベースを指定したり、名前付きインスタンスを指定したりするには、次の手順で示すように `-S` オプションを使用します)。 `-if` オプションは、ワークロード ファイル ( [!INCLUDE[tsql](../../includes/tsql-md.md)] スクリプトまたはトレース ファイルが使用可能) の名前とファイル パスを指定し、 `-s` はチューニング セッションの名前を指定します。  
  
     ここで示した 4 つのオプション (データベース名、ワークロード、接続の種類、およびセッション名) は必ず指定する必要があります。  
  
#### <a name="to-tune-a-remote-database-or-a-named-instance-for-a-specific-duration"></a>リモート データベースまたは名前付きインスタンスを一定時間チューニングするには  
  
1.  解析時に、データベース エンジン チューニング アドバイザーによって追加、削除、または保有を検討するデータベースの機能 (インデックス、インデックス付きビュー、パーティション分割) を決定します。  
  
2.  ワークロードを作成します。 詳細については、このトピックの「 [ワークロードを作成する](#Create) 」を参照してください。  
  
3.  コマンド プロンプトで、次のコマンドを入力します。  
  
    ```  
    dta -S ServerName\Instance -D DatabaseName -it WorkloadTableName   
    -U LoginID -P Password -s SessionName -A TuningTimeInMinutes  
    ```  
  
     このコマンドの `-S` はリモート サーバー名とインスタンス (またはローカル サーバー上の名前付きインスタンス) を指定し、 `-D` はチューニングするデータベースの名前を指定します。 `-it` オプションはワークロード テーブル名を指定し、 `-U` および `-P` はリモート データベースに対するログイン ID とパスワードを指定します。また、 `-s` はチューニング セッション名を指定し、 `-A` はチューニング セッションの継続時間を分単位で指定します。 既定では、 **dta** ユーティリティのチューニング時間は 8 時間に設定されています。 データベース エンジン チューニング アドバイザーによるワークロードのチューニング時間を無制限にする場合は、 **オプションを使用して** 0 `-A` (ゼロ) を指定します。  
  
#### <a name="to-tune-a-database-using-an-xml-input-file"></a>XML 入力ファイルを使用してデータベースをチューニングするには  
  
1.  解析時に、データベース エンジン チューニング アドバイザーによって追加、削除、または保有を検討するデータベースの機能 (インデックス、インデックス付きビュー、パーティション分割) を決定します。  
  
2.  ワークロードを作成します。 詳細については、このトピックの「 [ワークロードを作成する](#Create) 」を参照してください。  
  
3.  XML 入力ファイルを作成します。 詳細については、このトピックの「 [XML 入力ファイルを作成する](#XMLInput) 」を参照してください。  
  
4.  コマンド プロンプトで、次のコマンドを入力します。  
  
    ```  
    dta -E -S ServerName\Instance -s SessionName -ix PathToXMLInputFile  
    ```  
  
     このコマンドの `-E` は信頼関係接続を指定し、 `-S` はリモート サーバーとインスタンス、またはローカル サーバー上の名前付きインスタンスを指定します。また、 `-s` はチューニング セッション名を指定し、 `-ix` はチューニング セッションで使用する XML 入力ファイルを指定します。  
  
5.  ユーティリティによるワークロードのチューニングが完了した後、データベース エンジン チューニング アドバイザーの GUI を使用して、チューニング セッションの結果を参照できます。 また、代替手段として、 **-ox** オプションを使用してチューニングの推奨設定を XML ファイルに書き込むように指定することもできます。 詳細については、「 [dta Utility](../../tools/dta/dta-utility.md)」をご参照ください。  
  
##  <a name="create-an-xml-input-file"></a><a name="XMLInput"></a> XML 入力ファイルを作成する  
 経験豊かな XML 開発者の場合、 [!INCLUDE[ssDE](../../includes/ssde-md.md)] チューニング アドバイザーで使用できる XML 形式のファイルを作成して、ワークロードをチューニングできます。 このような XML ファイルを作成するには、使い慣れた XML ツールを使用してサンプル ファイルを編集するか、 [!INCLUDE[ssDE](../../includes/ssde-md.md)] チューニング アドバイザーの XML スキーマからインスタンスを生成します。  
  
 [!INCLUDE[ssDE](../../includes/ssde-md.md)] チューニング アドバイザーの XML スキーマは、[!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] インストールの次の場所から入手できます。  
  
 `C:\Program Files\Microsoft SQL Server\100\Tools\Binn\schemas\sqlserver\2004\07\dta\dtaschema.xsd` 
  
 [!INCLUDE[ssDE](../../includes/ssde-md.md)] チューニング アドバイザーの XML スキーマは、この [Microsoft Web サイト](https://go.microsoft.com/fwlink/?linkid=43100&clcid=0x409)からもオンラインで入手できます。  
  
 この URL から、多くの [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] XML スキーマを入手できるページに移動できます。 [!INCLUDE[ssDE](../../includes/ssde-md.md)] チューニング アドバイザーの行までページを下にスクロールします。  
  
#### <a name="to-create-an-xml-input-file-to-tune-workloads"></a>XML 入力ファイルを作成してワークロードをチューニングするには  
  
1.  ワークロードを作成します。 [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)]の Tuning テンプレートを使用してトレース ファイルまたはトレース テーブルを使用できます。または、 [!INCLUDE[tsql](../../includes/tsql-md.md)] の代表的なワークロードを再現する [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]スクリプトを作成できます。 詳細については、このトピックの「 [ワークロードを作成する](#Create) 」を参照してください。  
  
2.  次のいずれかの方法で、XML 入力ファイルを作成します。  
  
    -   「[XML 入力ファイルのサンプル &#40;DTA&#41;](../../tools/dta/xml-input-file-samples-dta.md)」の 1 つをコピーし、使い慣れた XML エディターに貼り付けます。 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] インストールに適切な引数を指定するために値を変更し、XML ファイルを保存します。  
  
    -   使い慣れた XML ツールを使用して、 [!INCLUDE[ssDE](../../includes/ssde-md.md)] チューニング アドバイザーの XML スキーマからインスタンスを生成します。  
  
3.  XML 入力ファイルを作成した後、その XML 入力ファイルを **dta** コマンド ライン ユーティリティへの入力として使用して、ワークロードをチューニングします。 このツールでの XML 入力ファイルの使用については、このトピックの「 [dta ユーティリティを使用する](#dta) 」を参照してください。  
  
> [!NOTE]  
>  XML 入力ファイル内で直接指定されるワークロードであるインライン ワークロードを使用する場合、サンプル「[インライン ワークロードを使用した XML 入力ファイルのサンプル &#40;DTA&#41;](../../tools/dta/xml-input-file-sample-with-inline-workload-dta.md)」を使用します。  
  
##  <a name="user-interface-descriptions"></a><a name="UI"></a> ユーザー インターフェイスの説明  
  
### <a name="tools-menuoptions-page"></a>[ツール] メニュー/[オプション] ページ  
 このダイアログ ボックスを使用すると、データベース エンジン チューニング アドバイザーの全般的な構成パラメーターを指定できます。  
  
 **[スタートアップ時]**  
 データベース エンジン チューニング アドバイザーの開始時に実行する操作を指定します。指定できる操作は、データベース接続を行わずに開く、 **[新しい接続]** ダイアログ ボックスを表示する、新しいセッションを表示する、前回読み込んだセッションを読み込む、のいずれかです。  
  
 **[フォント変更]**  
 データベース エンジン チューニング アドバイザーの表で使用される表示フォントを指定します。  
  
 **[最近使用した項目の一覧に表示する項目数]**  
 **[ファイル]** メニューの **[最新のセッション]** または **[最近使ったファイル]** で表示されるセッションやファイルの数を指定します。  
  
 **[最後のチューニング オプションを保存する]**  
 セッションとセッションの間でチューニング オプションを保持します。 既定で選択されています。 このチェック ボックスをオフにすると、データベース チューニング アドバイザーは常に既定のオプションで起動します。  
  
 **[完全にセッションを削除する前に確認する]**  
 セッションを削除する前に、確認のダイアログ ボックスを表示します。  
  
 **[セッションの分析を停止する前に確認する]**  
 ワークロードの分析を停止する前に、確認ダイアログ ボックスを表示します。  
  
#### <a name="general-tab-options"></a>[全般] タブのオプション  
 セッションのチューニングを始める前に、 **[全般]** タブのフィールドを設定する必要があります。 **[チューニング オプション]** タブの設定は、チューニング セッションを開始する前に変更する必要はありません。  
  
 **[セッション名]**  
 セッションの名前を指定します。 これによって、チューニングするセッションに名前が関連付けられます。 後でこの名前を参照することで、チューニングするセッションを確認できます。  
  
 **[最近使ったファイル]**  
 ワークロードとなる .sql スクリプトまたはトレース ファイルを指定します。 対応するテキスト ボックスにパスとファイル名を指定します。 データベース エンジン チューニング アドバイザーでは、ワークロード トレース ファイルはロールオーバー ファイルと見なされます。 ロールオーバー ファイルの詳細については、「 [Limit Trace File and Table Sizes](../../relational-databases/sql-trace/limit-trace-file-and-table-sizes.md)」を参照してください。  
  
 **Table**  
 ワークロードのトレース テーブルを指定します。 次のように、対応するテキスト ボックスにトレース テーブルの完全修飾名を指定します。  
  
```  
database_name.owner_name.table_name  
```  
  
-   トレース テーブルをワークロードとして使用する前に、トレースが停止していることを確認します。  
  
-   トレース テーブルは、データベース エンジン チューニング アドバイザーでチューニングするサーバーと同じサーバーに置く必要があります。 他のサーバーにトレース テーブルを作成した場合は、トレース テーブルをデータベース エンジン チューニング アドバイザーでチューニングするサーバーに移動してください。  
  
 **[プラン キャッシュ]**  
 プラン キャッシュをワークロードとして指定します。 このようにすることでワークロードを手動で作成する手間が省けます。 データベース エンジン チューニング アドバイザーによって、分析に使用される上位 1,000 件のイベントが選択されます。  
  
 **Xml**  
 これは [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]からワークロードをインポートしない限り表示されません。  
  
 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]からワークロード クエリをインポートするには、次の操作を行います。  
  
1.  クエリ エディターにクエリを入力し、選択して強調表示します。  
  
2.  強調表示したクエリを右クリックして、 **[データベース エンジン チューニング アドバイザーでのクエリの分析]** をクリックします。  
  
 **[ワークロード ファイルを参照します。]/[ワークロード テーブルを参照します。]**  
 ワークロードのソースとして **[ファイル]** または **[テーブル]** を選択している場合に、この参照ボタンを使用して対象を選択します。  
  
 **[XML ワークロードをプレビューします。]**  
 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]からインポートされた XML 形式のワークロードを表示します。  
  
 **[ワークロード分析用のデータベース]**  
 データベース エンジン チューニング アドバイザーがワークロードのチューニング時に最初に接続するデータベースを指定します。 チューニングの開始後に、データベース チューニング アドバイザーは、ワークロードに含まれる `USE DATABASE` ステートメントで指定されたデータベースに接続します。  
  
 **[チューニングするデータベースとテーブルの選択]**  
 チューニングするデータベースとテーブルを指定します。 すべてのデータベースを指定するには、 **[名前]** 列ヘッダーのチェック ボックスをオンにします。 特定のデータベースを指定するには、そのデータベース名の横にあるチェック ボックスをオンにします。 既定では、選択したデータベースのすべてのテーブルが自動的にチューニング対象のセッションに含まれます。 テーブルを除外するには、 **[選択したテーブル]** 列の矢印をクリックした後、チューニングの対象にしないテーブルの横にあるチェック ボックスをオフにします。  
  
 **[選択したテーブル]** の下向き矢印  
 テーブルの一覧を展開して、チューニングするテーブルを個別に選択できます。  
  
 **[チューニング ログを保存する]**  
 セッション中のログを作成し、エラーを記録します。  
  
> [!NOTE]  
>  データベース エンジン チューニング アドバイザーの **[全般]** タブに表示されるテーブルの行情報は、自動的に更新されません。この情報はデータベースのメタデータに依存しています。 行の情報が古くなっていると感じた場合は、対応するオブジェクトに対して DBCC UPDATEUSAGE コマンドを実行してください。  
  
##### <a name="tuning-tab-options"></a>[チューニング オプション] タブのオプション  
 **[チューニング オプション]** タブを使用すると、全般的なチューニング オプションの既定の設定を変更できます。 **[チューニング オプション]** タブの設定は、チューニング セッションを開始する前に変更する必要はありません。  
  
 **[チューニング時間を制限する]**  
 現在のチューニング セッションの時間を制限します。 チューニングの時間を増やすことにより、推奨設定の品質が向上します。 推奨設定で最良の結果を得るためには、このオプションをオンにしないでください。  
  
> [!NOTE]  
> [!INCLUDE[ssDE](../../includes/ssde-md.md)] チューニング アドバイザーは、分析中にシステム リソースを使用します。 **[チューニング時間を制限する]** を使用すると、チューニング対象サーバーでワークロードの増大が予想される期間の前にチューニングを停止できます。  
  
 **[詳細設定オプション]**  
 **[チューニング オプションの詳細設定]** ダイアログ ボックスを使用すると、最大領域、最大キー列数、およびオンライン推奨インデックスを構成できます。  
  
 **[推奨インデックス用の最大領域を定義する (MB)]**  
 物理デザイン構造が使用する最大領域として、データベース エンジン チューニング アドバイザーによる推奨値を入力します。  
  
 値を入力しない場合は、データベース エンジン チューニング アドバイザーは、次の領域制限より小さい値を想定します。  
  
-   現在の生データ サイズの 3 倍。このサイズには、データベース内のテーブルのヒープとクラスター化インデックスの合計サイズが含まれます。  
  
-   アタッチ先のすべてのディスク ドライブの空き容量に生データのサイズを加算した値  
  
 **[すべてのデータベースのプラン キャッシュ イベントを含める]**  
 すべてのデータベースのプラン キャッシュ イベントが分析されるように指定します。  
  
 **[インデックスごとの最大列数]**  
 任意のインデックスに含める最大列数を指定します。 既定値は 1023 です。  
  
 **[すべての推奨インデックスをオフラインにする]**  
 可能な限り最良の推奨が生成されますが、物理デザイン構造をオンラインで作成することはお勧めしません。  
  
 **[可能な限りオンラインの推奨インデックスを生成する]**  
 推奨を実装する [!INCLUDE[tsql](../../includes/tsql-md.md)] ステートメントを作成するときに、より速いオフライン メソッドが利用可能な場合でも、サーバー オンラインで実装できるメソッドを選択します。  
  
 **[オンラインの推奨インデックスのみ生成する]**  
 サーバーでオンライン状態を維持できる推奨インデックスのみ生成します。  
  
 **[停止時刻]**  
 [!INCLUDE[ssDE](../../includes/ssde-md.md)] チューニング アドバイザーを停止する日時を指定します。  
  
 **[インデックスおよびインデックス付きビュー]**  
 このオプションをオンにすると、クラスター化インデックス、非クラスター化インデックス、およびインデックス付きビューを追加するための推奨設定が含まれます。  
  
 **インデックス付きビュー**  
 インデックス付きビューを追加するための推奨設定のみが含まれます。 クラスター化インデックスおよび非クラスター化インデックスは、推奨されません。  
  
 **フィルター選択されたインデックスを含める**  
 フィルター選択されたインデックスを追加するための推奨設定が含まれます。 このオプションは、 **[インデックスおよびインデックス付きビュー]** 、 **[インデックス]** 、または **[非クラスター化インデックス]** のいずれかの物理デザイン構造を選択した場合に使用できます。  
  
 **インデックス**  
 クラスター化インデックスおよび非クラスター化インデックスを追加するための推奨設定のみが含まれます。 インデックス付きビューは推奨されません。  
  
 **[非クラスター化インデックス]**  
 非クラスター化インデックスだけの推奨設定が含まれます。 クラスター化インデックスおよびインデックス付きビューは推奨されません。  
  
 **[既存の PDS のみ使用を評価する]**  
 現在のインデックスの効果を評価しますが、追加のインデックスまたはインデックス付きビューは推奨されません。  
  
 **パーティション分割しない。**  
 パーティション分割を推奨しません。  
  
 **[完全パーティション分割]**  
 パーティション分割の推奨設定を含みます。  
  
 **[固定パーティション分割]**  
 パーティション分割を簡単に維持できるように、新しく推奨されたパーティションが固定されます。  
  
 **[既存の PDS を保持しない]**  
 不要な既存のインデックス、ビュー、およびパーティション分割の削除を推奨します。 既存の物理デザイン構造 (PDS) がワークロードに対して有用である場合、 [!INCLUDE[ssDE](../../includes/ssde-md.md)] チューニング アドバイザーは削除を推奨しません。  
  
 **[インデックスのみ保持する]**  
 既存のインデックスをすべて保持しますが、不要なインデックス付きビューおよびパーティション分割の削除を推奨します。  
  
 **[既存の PDS をすべて保持する]**  
 既存のインデックス、インデックス付きビュー、およびパーティション分割をすべて保持します。  
  
 **[クラスター化インデックスのみ保持する]**  
 既存のクラスター化インデックスをすべて保持しますが、不要なインデックス付きビュー、パーティション分割、および非クラスター化インデックスの削除を推奨します。  
  
 **[固定パーティション分割を保持する]**  
 現在固定されているパーティション分割構造を保持しますが、不要なインデックス付きビュー、インデックス、および固定されていないパーティション分割の削除を推奨します。 推奨される追加のパーティション分割はすべて現在のパーティション分割構成で固定されます。  
  
###### <a name="progress-tab-options"></a>[進行状況] タブのオプション  
 データベース エンジン チューニング アドバイザーでワークロードの分析を開始すると、[データベース エンジン チューニング アドバイザー] の **[進行状況]** タブが表示されます。  
  
 チューニング セッションの開始後にセッションを停止する場合、 **[アクション]** メニューにある次のオプションから 1 つを選択します。  
  
-   **[分析の停止 (推奨設定を使用)]** を選択すると、チューニング セッションが停止され、この時点までに実行された分析に基づいて、データベース エンジン チューニング アドバイザーで推奨設定を生成するかどうかを決定するように求めるメッセージが表示されます。  
  
-   **[分析の停止]** を選択すると、推奨設定を生成せずにチューニング セッションを停止します。  
  
 **[チューニングの進行状況]**  
 現在の進行状況の状態を示します。 実行された処理の数、および受け取ったエラー メッセージ、成功メッセージ、警告メッセージの数が表示されます。  
  
 **詳細**  
 状態を示すアイコンが表示されます。  
  
 **操作**  
 実行中のステップが表示されます。  
  
 **状態**  
 アクション ステップの状態が表示されます。  
  
 **メッセージ**  
 アクション ステップで返されたメッセージが表示されます。  
  
 **[チューニング ログ]**  
 このチューニング セッションに関する情報が表示されます。 このログを印刷するには、ログを右クリックして **[印刷]** をクリックします。  
  
## <a name="see-also"></a>参照  
 [データベース エンジン チューニング アドバイザーからの出力の表示および操作](../../relational-databases/performance/view-and-work-with-the-output-from-the-database-engine-tuning-advisor.md)   
 [dta ユーティリティ](../../tools/dta/dta-utility.md)    
 [チュートリアル:データベース エンジン チューニング アドバイザー](../../tools/dta/tutorial-database-engine-tuning-advisor.md)
