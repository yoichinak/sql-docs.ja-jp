---
title: セキュア エンクレーブを使用する Always Encrypted
description: セキュリティで保護されたエンクレーブが設定された SQL Server の Always Encrypted について説明します。
ms.custom: seo-lt-2019
ms.date: 10/31/2019
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: vanto
ms.technology: security
ms.topic: conceptual
author: jaszymas
ms.author: jaszymas
monikerRange: '>= sql-server-ver15 || = sqlallproducts-allversions'
ms.openlocfilehash: 64680ae71e34d1da94bf0ec8b2ab1ef75cd3c4d3
ms.sourcegitcommit: 22e97435c8b692f7612c4a6d3fe9e9baeaecbb94
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/27/2020
ms.locfileid: "92679023"
---
# <a name="always-encrypted-with-secure-enclaves"></a>セキュア エンクレーブを使用する Always Encrypted
[!INCLUDE [sqlserver2019-windows-only](../../../includes/applies-to-version/sqlserver2019-windows-only.md)]
 
セキュリティで保護されたエンクレーブが設定された Always Encrypted は、[Always Encrypted](always-encrypted-database-engine.md) 機能に追加機能を提供します。

SQL Server 2016 で導入された Always Encrypted は、注意が必要なデータの機密性を、マルウェアと、SQL Server の高い特権を持つ *未承認* の SQL ユーザーから保護します。 高い特権を持つ未承認のユーザーとは、DBA、コンピューター管理者、クラウド管理者、またはサーバー インスタンス、ハードウェアなどに対する正当なアクセス権を持ち、実際のデータの一部またはすべてにアクセスすべきではないユーザーです。  

この記事で説明されている機能強化を設定しないと、Always Encrypted では、クライアント側でデータを暗号化し、データまたは対応する暗号化キーが SQL Server Engine 内でプレーンテキストで表示されないようにすることで、データが保護されます。 その結果、データベース内の暗号化された列に対する機能が大幅に制限されます。 暗号化されたデータに対して SQL Server で実行できる操作は、等価比較のみです (決定論的暗号化でのみ使用できます)。 暗号化操作 (最初のデータ暗号化、キーの交換) や高度な計算 (パターン マッチングなど) などの他のすべての操作は、データベース内ではサポートされていません。 ユーザーがクライアント側でこのような操作を実行するには、データベースの外部にデータを移動する必要があります。

*セキュリティで保護されたエンクレーブ* が設定された Always Encrypted では、サーバー側でセキュリティで保護されたエンクレーブ内のプレーンテキストに対する計算を許可することで、このような制限に対応しています。 セキュリティで保護されたエンクレーブは、SQL Server プロセス内のメモリの保護された領域であり、SQL Server エンジン内の機密データを処理するための信頼できる実行環境として機能します。 セキュリティで保護されたエンクレーブは、他の SQL Server やホスティング マシン上の他のプロセスからは、不透明なボックスに見えます。 デバッガーを使用しても、外部からエンクレーブ内のデータやコードを表示する方法はありません。  


Always Encrypted は、次の図のようにセキュリティで保護されたエンクレーブを使用します。

![データ フロー (data flow)](./media/always-encrypted-enclaves/ae-data-flow.png)



SQL Server Engine は、アプリケーションのクエリを解析するときに、セキュリティで保護されたエンクレーブを使用する必要がある暗号化されたデータに対する操作がクエリに含まれているかどうかを判断します。 セキュリティで保護されたエンクレーブにアクセスする必要があるクエリの場合:

- クライアント ドライバーから、操作に必要な列の暗号化キーが (セキュリティで保護されたチャネルを介して) セキュリティで保護されたエンクレーブに送信されます。 
- 次に、クライアント ドライバーから、暗号化されたクエリ パラメーターと共に実行に関するクエリが送信されます。

クエリ処理時に、データまたは列の暗号化キーは、セキュリティで保護されたエンクレーブの外部にある SQL Server エンジンではプレーンテキストで公開されません。 SQL Server エンジンでは、暗号化された列に対する暗号化操作と計算が、セキュリティで保護されたエンクレーブに委任されます。 セキュリティで保護されたエンクレーブでは、必要に応じて、暗号化された列に格納されているクエリ パラメーターやデータが復号化され、要求された操作が実行されます。

[!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] のセキュリティで保護されたエンクレーブが設定された Always Encrypted は、Windows で[仮想化ベースのセキュリティ (VBS)](https://www.microsoft.com/security/blog/2018/06/05/virtualization-based-security-vbs-memory-enclaves-data-protection-through-isolation/) のセキュリティで保護されたメモリ エンクレーブ (仮想保護モード (VSM) エンクレーブとも呼ばれます) を使用します。

## <a name="why-use-always-encrypted-with-secure-enclaves"></a>セキュリティで保護されたエンクレーブが設定された Always Encrypted を使用する理由

セキュリティで保護されたエンクレーブを設定して Always Encrypted を使用すると、注意が必要なデータの機密性を保護できるだけでなく、次の利点もあります。

- **インプレース暗号化** : 最初のデータ暗号化や列暗号化キーの交換など、機密データに対する暗号化操作はセキュリティで保護されたエンクレーブ内で実行され、データをデータベースの外部に移動する必要はありません。 ALTER TABLE Transact-SQL ステートメントを使用してインプレース暗号化を発行することができます。SSMS の Always Encrypted ウィザードや Set-SqlColumnEncryption PowerShell コマンドレットなどのツールを使用する必要はありません。

- **高度な計算** : パターン マッチング (LIKE 述語) と範囲比較など、暗号化された列に対する操作は、セキュリティで保護されたエンクレーブ内でサポートされます。そのため、データベース システム内でこのような計算を実行する必要がある幅広いアプリケーションやシナリオに Always Encrypted を使用できます。

## <a name="secure-enclave-attestation"></a>セキュリティで保護されたエンクレーブの構成証明

SQL Server エンジン内のセキュリティで保護されたエンクレーブは、暗号化されたデータベース列に格納されている機密データと、それに対応するプレーンテキストの列の暗号化キーにアクセスできます。 エンクレーブの計算を伴うクエリを SQL Server に送信する前に、アプリケーション内のクライアント ドライバーで、セキュリティで保護されたエンクレーブが特定のテクノロジ (VBS など) に基づく正規のエンクレーブであり、エンクレーブ内で実行されているコードが、エンクレーブ内で実行するために署名されていることを検証する必要があります。 

エンクレーブを検証するプロセスは、 **エンクレーブの構成証明** と呼ばれ、外部の構成証明サービスに接続するアプリケーション内のクライアント ドライバーと SQL Server の両方も含まれます。 構成証明プロセスの詳細は、エンクレーブ テクノロジと構成証明サービスによって変わります。

[!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] 内の VBS セキュリティで保護されたエンクレーブに対して SQL Server がサポートする構成証明プロセスは、ホスト ガーディアン サービス (HGS) を構成証明サービスとして使用する Windows Defender System Guard ランタイム構成証明です。 お使いの環境で HGS を構成し、SQL Server インスタンスをホストしているマシンを HGS に登録する必要があります。 また、HGS 構成証明を使用してクライアント アプリケーションまたはツール (たとえば、SQL Server Management Studio) も構成する必要があります。

## <a name="supported-client-drivers"></a>サポートされるクライアント ドライバー

セキュリティで保護されたエンクレーブが設定された Always Encrypted を使用するには、アプリケーションでこの機能をサポートするクライアント ドライバーを使用する必要があります。 エンクレーブの計算とエンクレーブの構成証明を有効にするように、アプリケーションとクライアント ドライバーを構成する必要があります。 サポートされているクライアント ドライバーの一覧などの詳細については、「[Always Encrypted を使用したアプリケーションの開発](always-encrypted-client-development.md)」を参照してください。

## <a name="enclave-enabled-keys"></a>エンクレーブ対応キー

セキュリティで保護されたエンクレーブが設定された Always Encrypted では、エンクレーブ対応キーの概念が導入されました。

- **Enclave 対応列マスター キー** : データベース内の列マスター キー メタデータ オブジェクトに ENCLAVE_COMPUTATIONS プロパティが指定されている列マスター キーです。 列マスター キー メタデータ オブジェクトには、メタデータ プロパティの有効な署名も含める必要があります。
- **エンクレーブ対応列暗号化キー** : エンクレーブ対応列マスター キーで暗号化された列暗号化キーです。

SQL Server エンジンは、クエリで指定された操作をセキュリティで保護されたエンクレーブ内で実行する必要があると判断した場合、SQL Server エンジンはクライアント ドライバーに対して、セキュリティで保護されたエンクレーブを使用した計算に必要な列暗号化キーを共有するよう要求します。 クライアント ドライバーでは、キーがエンクレーブ対応であり (つまり、エンクレーブ対応列マスター キーを使用して暗号化されており)、適切に署名されている場合にのみ、列暗号化キーを共有します。 それ以外の場合、クエリは失敗します。

詳細については、「[セキュリティで保護されたエンクレーブが設定された Always Encrypted のキーの管理](always-encrypted-enclaves-manage-keys.md)」を参照してください。

## <a name="enclave-enabled-columns"></a>エンクレーブ対応列

エンクレーブ対応列は、エンクレーブ対応列暗号化キーを使用して暗号化されたデータベース列です。 エンクレーブ対応列に使用できる機能は、列が使用している暗号化の種類によって異なります。

- **決定論的な暗号化** : 決定論的な暗号化を使用するエンクレーブ対応列はインプレース暗号化をサポートしていますが、セキュリティで保護されたエンクレーブ内の他の操作はサポートされていません。 等価比較はサポートされていますが、エンクレーブの外部の暗号文と比較することによって実行されます。  
- **ランダム化された暗号化** : ランダム化された暗号化を使用するエンクレーブ対応列は、セキュリティで保護されたエンクレーブ内で、インプレース暗号化と高度な計算をサポートしています。 サポートされている高度な計算は、パターン マッチングと等価比較を含む[比較演算子](../../../t-sql/language-elements/comparison-operators-transact-sql.md)です。

暗号化の種類については、「[Always Encrypted による暗号化](always-encrypted-cryptography.md)」を参照してください。

次の表は、列がエンクレーブ対応列暗号化キーと暗号化の種類を使用するかどうかに応じて、暗号化列に使用できる機能をまとめたものです。

| **操作**| **列はエンクレーブ対応ではない** |**列はエンクレーブ対応ではない**| **列はエンクレーブ対応**  |**列はエンクレーブ対応** |
|:---|:---|:---|:---|:---|
| | **ランダム化された暗号化**  | **決定論的な暗号化**     | **ランダム化された暗号化**      | **決定論的な暗号化**     |
| **インプレース暗号化** | サポートされていません  | サポートされていません   | サポートされています         | サポートされています    |
| **等価比較**   | サポートされていません | エンクレーブの外部でサポートされます | (エンクレーブの内部で) サポートされます | エンクレーブの外部でサポートされます |
| **等価かどうか以外の比較演算子** | サポートされていません  | サポートされていません   | サポートされています      | サポートされていません     |
| **LIKE**    | サポートされていません      | サポートされていません    | サポートされています     | サポートされていません    |

インプレース暗号化では、エンクレーブ内の次の操作が含まれています。

- 既存の列に格納されているデータの最初の暗号化。
- 次の例のように、列内の既存のデータを再暗号化します。
  
  - 列暗号化キーを交換します (新しいキーで列を再暗号化します)。
  - 暗号化の種類の変更  

- 暗号化された列に格納されているデータを復号化します (列をプレーンテキスト列に変換します)。

インプレース暗号化を可能にするには、暗号化操作に関連する 1 つまたは複数の列暗号化キーをエンクレーブ対応にする必要があります。

- 最初の暗号化: 暗号化される列の列暗号化キーは、エンクレーブ対応にする必要があります。
- 再暗号化: 現在の列暗号化キーとターゲットの列暗号化キー (現在のキーと異なる場合) の両方をエンクレーブ対応にする必要があります。
- 復号化: 列の現在の列暗号化キーはエンクレーブ対応にする必要があります。

### <a name="indexes-on-enclave-enabled-columns-using-randomized-encryption"></a>ランダム化された暗号化を使用してエンクレーブ対応の列でインデックスを作成する
ランダム化された暗号化を使用してエンクレーブ対応の列で非クラスター化インデックスを作成し、高度なクエリの実行を高速化できます。 ランダム化された暗号化を使用して暗号化された列のインデックスで機密データが漏えいしないようにし、同時に、エンクレーブ内でのクエリの処理に便利なように、インデックス データ構造 (B ツリー) 内のキーの値は、プレーンテキストの値に基づいて暗号化され、並べ替えられます。 SQL Server エンジン内のクエリ Executor では、エンクレーブ内での計算のために暗号化された列のインデックスが使われるときに、インデックスを検索して列に格納されている特定の値が探索されます。 各検索には、複数の比較が含まれる場合があります。 クエリ Executor では各比較がエンクレーブにデリゲートされ、エンクレーブでは列に格納されている値と比較対象の暗号化されたインデックス キーの値が復号化されて、プレーンテキストで比較が実行された後、比較の結果が Executor に返されます。 

ランダム化された暗号化を使用し、エンクレーブ対応ではない列でのインデックスの作成は、やはりサポートされていません。

詳細については、「[セキュリティで保護されたエンクレーブが設定された Always Encrypted を使用する列でインデックスを作成して使用する](always-encrypted-enclaves-create-use-indexes.md)」を参照してください。 SQL Server でのインデックス作成の処理方法に関する、Always Encrypted に固有ではない一般的な情報については、「[クラスター化インデックスと非クラスター化インデックスの概念](../../indexes/clustered-and-nonclustered-indexes-described.md)」をご覧ください。

#### <a name="database-recovery"></a>データベース復旧

SQL Server のインスタンスで障害が発生した場合、そのデータベースは、完了しなかったトランザクションによる変更がデータ ファイルに含まれ状態のままになる可能性があります。 インスタンスが起動されると、[データベース復旧](../../logs/the-transaction-log-sql-server.md#recovery-of-all-incomplete-transactions-when--is-started)と呼ばれるプロセスが実行されます。このプロセスでは、トランザクション ログで見つかったすべての未完了のトランザクションがロールバックされて、データベースの整合性が保持されます。 未完了のトランザクションによってインデックスの変更が行われた場合、それらの変更も元に戻す必要があります。 たとえば、インデックス内の一部のキー値は、削除するか、再挿入する必要があります。

> [!IMPORTANT]
> ランダム化された暗号化を使用して暗号化されているエンクレーブ対応の列で最初のインデックスを作成する **前** に、データベースに対して [高速データベース復旧 (ADR)](../../backup-restore/restore-and-recovery-overview-sql-server.md#adr) を有効にすることを強くお勧めします。

[従来のデータベース復旧プロセス](/azure/sql-database/sql-database-accelerated-database-recovery#the-current-database-recovery-process) ([ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) 復旧モデルに従うもの) では、インデックスに対する変更を元に戻すには、アプリケーションが列の列暗号化キーをエンクレーブに提供するまで SQL Server は待機する必要があり、長くかかることがあります。 ADR では、エンクレーブ内のキャッシュで列暗号化キーを使用できないために遅延する必要がある元に戻す操作の数が、劇的に減少します。 その結果、新しいトランザクションがブロックされる可能性が最小限になり、データベースの可用性が大幅に向上します。 ADR を有効にしても、SQL Server ではやはり古いデータ バージョンのクリーンアップを完了するために列暗号化キーが必要になる場合がありますが、データベースまたはユーザーのトランザクションの可用性に影響を与えないバックグラウンド タスクとして行われます。 ただし、列暗号化キーがないためにクリーンアップ操作が失敗したことを示すエラー メッセージが、エラー ログに記録されることがあります。

### <a name="indexes-on-enclave-enabled-columns-using-deterministic-encryption"></a>決定論的な暗号化を使用してエンクレーブ対応の列でインデックスを作成する

決定論的な暗号化を使用する列でのインデックスは、列がエンクレーブ対応かどうかに関係なく、(プレーンテキストではなく) 暗号化テキストに基づいて並べ替えられます。

## <a name="security-considerations"></a>セキュリティに関する考慮事項

セキュリティで保護されたエンクレーブが設定された Always Encrypted に対しては、次のセキュリティに関する考慮事項が適用されます。

- エンクレーブ内のデータのセキュリティは、構成証明プロトコルと構成証明サービスに依存します。 そのため、構成証明サービスと、構成証明サービスによって適用される構成証明ポリシーを、信頼できる管理者が管理する必要があります。 また、通常、構成証明サービスではさまざまなポリシーと構成証明プロトコルがサポートされており、そのうちの一部は、エンクレーブとその環境の最小限の検証を実行する、テストと開発用に設計されたものです。 お使いの構成証明サービスに固有のガイドラインに厳密に従って、運用環境の配置には推奨される構成とポリシーを使うようにしてください。 
- エンクレーブ対応の CEK でランダム化された暗号化を使用して列を暗号化すると、列による範囲比較のサポートのため、列に格納されたデータの順序がリークする可能性があります。 たとえば、従業員の給与が含まれる暗号化された列にインデックスがある場合、悪意のある DBA はインデックスをスキャンして暗号化された給与の最大値を検索し、給与が最高の個人を特定できます (ユーザーの名前は暗号化されていないものとします)。 
- Always Encrypted を使用して、DBA による不正アクセスから機密データを保護する場合は、列マスター キーまたは列暗号化キーを DBA と共有しないでください。 DBA は、キーに直接アクセスできなくても、エンクレーブ内の列暗号化キーのキャッシュを利用して、暗号化された列のインデックスを管理できます。

## <a name="considerations-for-availability-groups-and-database-migration"></a><a name="anchorname-1-considerations-availability-groups-db-migration"></a> 可用性グループとデータベースの移行に関する考慮事項

エンクレーブを使用するクエリをサポートするために必要な Always On 可用性グループを構成する場合は、可用性グループ内のデータベースをホストするすべての SQL Server インスタンスで、セキュリティで保護されたエンクレーブが設定された Always Encrypted をサポートし、エンクレーブを構成する必要があります。 プライマリ データベースではエンクレーブがサポートされていても、セカンダリ レプリカではサポートされていない場合、セキュリティで保護されたエンクレーブが設定された Always Encrypted の機能を使用しようとするクエリは失敗します。

エンクレーブが構成されていない SQL Server インスタンスで、セキュリティで保護されたエンクレーブが設定された Always Encrypted の機能を使用するデータベースのバックアップ ファイルを復元すると、復元操作は成功し、エンクレーブに依存しないすべての機能が使用可能になります。 しかし、エンクレーブ機能を使用する後続のクエリは失敗し、ランダム化された暗号化を使用するエンクレーブ対応の列のインデックスは無効になります。 エンクレーブが構成されていないインスタンスで、セキュリティで保護されたエンクレーブが設定された Always Encrypted を使用するデータベースをアタッチしたときも、同じようになります。

ランダム化された暗号化を使用するエンクレーブ対応の列のインデックスがデータベースに含まれる場合は、データベースのバックアップを作成する前に、データベースで[高速データベース復旧 (ADR)](../../backup-restore/restore-and-recovery-overview-sql-server.md#adr) を有効にしてください。 ADR では、データベースを復元した後すぐに、インデックスも含めて、データベースを使用できることが保証されます。 詳しくは、「[データベース復旧](#database-recovery)」をご覧ください。

bacpac ファイルを使ってデータベースを移行するときは、bacpac ファイルを作成する前に、ランダム化された暗号化を使用するエンクレーブ対応の列のすべてのインデックスを削除する必要があります。

## <a name="known-limitations"></a>既知の制限事項
セキュリティで保護されたエンクレーブが設定された Always Encrypted を使うと、次の操作を有効にすることで、Always Encrypted のいくつかの制限に対処できます。

- インプレース暗号操作。
- ランダム化された暗号化を使用して暗号化された列での、パターン マッチング (LIKE) および比較演算子。
    > [!NOTE]
    > 上記の操作は、バイナリ 2 並べ替え順序 (BIN2 照合順序) による照合順序を使用する文字列型の列に対してサポートされます。 BIN2 以外の照合順序を使用する文字列型の列は、ランダム化された暗号化およびエンクレーブ対応の列暗号化キーを使用して、暗号化できます。 ただし、このような列に対して有効な唯一の新機能はインプレース暗号化です。
- ランダム化された暗号化を使用する列での非クラスター化インデックスと統計の作成。

「[機能の詳細](always-encrypted-database-engine.md#feature-details)」に記載されている Always Encrypted に対する他のすべての制限は、セキュリティで保護されたエンクレーブが設定された Always Encrypted にも適用されます。

次の制限事項は、セキュリティで保護されたエンクレーブが設定された Always Encrypted に固有のものです。

- ランダム化された暗号化を使用するエンクレーブ対応の列では、クラスター化インデックスを作成できません。
- ランダム化された暗号化を使用するエンクレーブ対応の列を、主キー列にすることはできず、外部キー制約または一意キー制約によって参照することはできません。
- ランダム化された暗号化を使用するエンクレーブ対応の列では、入れ子になったループ結合 (可能な場合はインデックスを使用) のみがサポートされます。 ハッシュ結合およびマージ結合はサポートされていません。 
- 同じコード ページ内の照合順序および NULL 値の許容の変更を除き、インプレース暗号化操作を、列メタデータの他の変更と組み合わせることはできません。 たとえば、1 つの `ALTER TABLE`/`ALTER COLUMN` Transact-SQL ステートメントで列を暗号化、再暗号化、または復号化し、さらに列のデータ型を変更することはできません。 2 つの異なるステートメントを使用します。
- インメモリ テーブルの列にエンクレーブ対応キーを使用することは、サポートされていません。
- 計算列を定義する式では、ランダム化された暗号化を使用してエンクレーブが有効な列の計算を実行することはできません (計算が LIKE および範囲比較の場合でも)。
- ランダム化された暗号化を使用するエンクレーブ対応の列では、LIKE 演算子のパラメーターでのエスケープ文字はサポートされていません。
- (暗号化の後でラージ オブジェクトになる) 次のデータ型のいずれかを使用するクエリ パラメーターを持つ LIKE 演算子または比較演算子を含むクエリでは、インデックスは無視され、テーブル スキャンが実行されます。
    - `nchar[n]`、`nvarchar[n]` (n が 3967 より大きい場合)。
    - `char[n]`、`varchar[n]`、`binary[n]`、`varbinary[n]` (n が 7935 より大きい場合)。
- ツールの制限事項:
  - エンクレーブ対応列マスター キーを格納するためにサポートされるキー ストアは、Windows 証明書ストアと Azure Key Vault のみです。
  - エンクレーブ対応のキーが含まれるデータベースのインポート/エクスポートは、サポートされていません。
  - `ALTER TABLE`/`ALTER COLUMN` を使用してインプレース暗号化操作をトリガーするには、SSMS でクエリ ウィンドウを使用してステートメントを発行するか、ステートメントを発行する独自のプログラムを作成する必要があります。 現在、SqlServer PowerShell モジュールの Set-SqlColumnEncryption コマンドレットと SQL Server Management Studio の Always Encrypted ウィザードでは、インプレース暗号化はサポートされていません。操作に使用される列暗号化キーがエンクレーブ対応であっても、暗号化操作のためにデータベースからデータが移動されます。

## <a name="next-steps"></a>次のステップ
- [チュートリアル:SSMS を使用したセキュリティで保護されたエンクレーブを持つ Always Encrypted の概要](../tutorial-getting-started-with-always-encrypted-enclaves.md)
- [セキュリティで保護されたエンクレーブが設定された Always Encrypted を構成して使用する](configure-always-encrypted-enclaves.md)

## <a name="see-also"></a>関連項目
- [セキュリティで保護されたエンクレーブが設定された Always Encrypted のキーを管理する](always-encrypted-enclaves-manage-keys.md)
- [セキュリティで保護されたエンクレーブが設定された Always Encrypted を使用して列の暗号化をインプレースで構成する](always-encrypted-enclaves-configure-encryption.md)
- [セキュリティで保護されたエンクレーブが設定された Always Encrypted を使用する列のクエリを実行する](always-encrypted-enclaves-query-columns.md)
- [既存の暗号化された列に対してセキュリティで保護されたエンクレーブが設定された Always Encrypted を有効にする](always-encrypted-enclaves-enable-for-encrypted-columns.md)
- [セキュリティで保護されたエンクレーブ列が設定された Always Encrypted でのインデックスの作成と使用](always-encrypted-enclaves-create-use-indexes.md)
