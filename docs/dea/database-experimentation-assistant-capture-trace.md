---
title: SQL Server アップグレードのトレースをキャプチャする
description: Database Experimentation Assistant (DEA) を使用して、キャプチャされたサーバーイベントのログを含むトレースファイルを作成します。
ms.custom: seo-lt-2019
ms.date: 12/12/2019
ms.prod: sql
ms.prod_service: dea
ms.suite: sql
ms.technology: dea
ms.tgt_pltfrm: ''
ms.topic: conceptual
author: pochiraju
ms.author: rajpo
ms.reviewer: mathoma
ms.openlocfilehash: 67b427e7d1d73b072ce2ec319bfc3cbcbbcfddf9
ms.sourcegitcommit: 71d2389cf27156fa0404a6e6f65fb7a61c40789a
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/01/2020
ms.locfileid: "91636102"
---
# <a name="capture-a-trace-in-database-experimentation-assistant"></a>Database Experimentation Assistant でトレースをキャプチャする

Database Experimentation Assistant (DEA) を使用して、キャプチャされたサーバーイベントのログを含むトレースファイルを作成できます。 キャプチャされたサーバーイベントは、特定の期間に特定のサーバーで発生するイベントです。 トレースキャプチャは、サーバーごとに1回実行する必要があります。

トレースキャプチャを開始する前に、すべてのターゲットデータベースをバックアップしていることを確認してください。

SQL Server のクエリキャッシュは、評価結果に影響を与える可能性があります。 評価結果の一貫性を向上させるために、サービスアプリケーションで SQL Server サービス (MSSQLSERVER) を再起動することをお勧めします。

## <a name="configure-a-trace-capture"></a>トレースキャプチャの構成

1. DEA の左側のナビゲーションバーで、カメラアイコンを選択し、[ **すべてのキャプチャ** ] ページで [ **新しいキャプチャ**] を選択します。

    ![DEA でキャプチャを作成する](./media/database-experimentation-assistant-capture-trace/dea-initiate-capture.png)

2. [ **新しいキャプチャ** ] ページの [ **キャプチャの詳細**] で、次の情報を入力または選択します。

    - **キャプチャ名**: キャプチャのトレースファイルの名前を入力します。
    - **形式**: キャプチャの形式 (Trace または xevent) を指定します。
    - [**期間**]: トレースキャプチャを実行する時間の長さ (分単位) を選択します。
    - [**キャプチャの場所**]: トレースファイルの保存先のパスを選択します。

        > [!NOTE]
        > トレースファイルへのファイルパスは、SQL Server を実行しているコンピューター上にある必要があります。 SQL Server サービスが特定のアカウントに対して設定されていない場合、トレースファイルを書き込むために、指定したフォルダーに対する書き込みアクセス許可がサービスに必要な場合があります。

3. **[はい、手動でバックアップ**を作成しました] を選択してバックアップを実行したことを確認します。 チェック ボックスをオンにします。

4. [ **キャプチャの詳細**] で、次の情報を入力または選択します。

    - [**サーバーの種類**]: SQL server の種類 (**SqlServer**、 **AzureSqlDb**、 **AzureSqlManagedInstance**) を指定します。
    - **サーバー名**: SQL Server のサーバー名または IP アドレスを指定します。
    - **認証の種類**: [認証の種類] で [ **Windows**] を選択します。
    - **データベース名**: データベーストレースを開始するデータベースの名前を入力します。 データベースを指定しない場合は、サーバー上のすべてのデータベースでトレースがキャプチャされます。

5. シナリオに応じて、[ **接続を暗号化** し、 **サーバー証明書を信頼** する] チェックボックスをオンまたはオフにします。

    ![新しいキャプチャページ](./media/database-experimentation-assistant-capture-trace/dea-new-capture.png)

## <a name="start-the-trace-capture"></a>トレースキャプチャを開始する

1. 必要な情報を入力または選択したら、[ **開始** ] を選択してトレースキャプチャを開始します。

    入力した情報が有効な場合は、トレースキャプチャプロセスが開始されます。 そうしないと、無効なエントリを含むテキストボックスが赤色で強調表示されます。 エラーが発生した場合は、必要なエントリを修正し、[ **開始** ] を再度選択します。

    トレースキャプチャが実行されている間、[ **キャプチャの詳細**] の下にトレースキャプチャプロセスの状態と進行状況が表示されます。

    ![キャプチャの進行状況の監視](./media/database-experimentation-assistant-capture-trace/dea-capture-running.png)

2. トレースキャプチャの実行が完了すると、新しいトレース (.trc) ファイルが、初期構成中に指定した **キャプチャ場所** に保存されます。

    ![完了したトレースキャプチャ](./media/database-experimentation-assistant-capture-trace/dea-capture-complete.png)

    トレースファイルには、SQL Server データベースのアクティビティのトレース結果が含まれます。 .trc ファイルは、SQL Server によって検出および報告されたエラーに関する詳細情報を提供するように設計されています。

## <a name="frequently-asked-questions-about-trace-capture"></a>トレースキャプチャに関してよく寄せられる質問

DEA でのトレースキャプチャに関してよく寄せられる質問を次に示します。

**Q: 実稼働データベースでトレースキャプチャを実行すると、どのようなイベントがキャプチャされますか。**

次の表に、トレースで収集されるイベントと対応する列データを示します。
  
|イベント名|テキストデータ (1)|バイナリデータ (2)|データベース ID (3)|ホスト名 (8)|アプリケーション名 (10)|ログイン名 (11)|SPID (12)|開始時刻 (14)|終了時刻 (15)|データベース名 (35)|イベントシーケンス (51)|Issystem で (60)|  
|---|---|---|---|---|---|---|---|---|---|---|---|---|  
|**RPC: 完了 (10)**||*|*|*|*|*|*|*|*|*|*|*|  
|**RPC: 開始中 (11)**||*|*|*|*|*|*|*||*|*|*|  
|**RPC 出力パラメーター (100)**|*||*|*|*|*|*|*||*|*|*|  
|**SQL: BatchCompleted (12)**|*||*|*|*|*|*|*|*|*|*|*|  
|**SQL: BatchStarting (13)**|*||*|*|*|*|*|*||*|*|*|  
|**監査ログイン (14)**|*|*|*|*|*|*|*|*||*|*|*|  
|**監査ログアウト (15)**|*||*|*|*|*|*|*|*|*|*|*|  
|**ExistingConnection (17)**|*|*|*|*|*|*|*|*||*|*|*|  
|**カーソルを開く (53)**|*||*|*|*|*|*|*||*|*|*|  
|**カーソルの準備 (70)**|*||*|*|*|*|*|*||*|*|*|  
|**SQL の準備 (71)**|||*|*|*|*|*|*||*|*|*|  
|**Exec 準備された SQL (72)**|||*|*|*|*|*|*||*|*|*|  
|**カーソルの実行 (74)**|*||*|*|*|*|*|*||*|*|*|  
|**CursorUnprepare (77)**|*||*|*|*|*|*|*||*|*|*|  
|**カーソルを閉じる (78)**|*||*|*|*|*|*|*||*|*|*|  

**Q: トレースキャプチャが実行されている場合、実稼働サーバーにパフォーマンス上の影響はありますか。**

はい、トレースコレクションの実行中は、パフォーマンスの影響が最小限に抑えられます。 このテストでは、3% のメモリ不足が発生しました。

**Q: 運用ワークロードでトレースをキャプチャするには、どのような種類のアクセス許可が必要ですか。**

- DEA アプリケーションでトレース操作を実行する Windows ユーザーには、SQL Server を実行しているコンピューターに対する sysadmin 権限が必要です。
- SQL Server を実行しているコンピューターで使用されるサービスアカウントには、指定されたトレースファイルパスへの書き込みアクセス権が必要です。

**Q: サーバー全体または1つのデータベースのみのトレースをキャプチャすることはできますか。**

DEA を使用すると、サーバー内のすべてのデータベースまたは単一のデータベースのトレースを取り込むことができます。

**Q: 実稼働環境にリンクサーバーが構成されています。これらのクエリはトレースに表示されますか。**

サーバー全体のトレースキャプチャを実行している場合は、リンクサーバークエリを含むすべてのクエリがトレースによってキャプチャされます。 サーバー全体のトレースキャプチャを実行するには、[**新しいキャプチャ**] の [**データベース名**] ボックスを空のままにします。

**Q: 実稼働ワークロードトレースで推奨される最小時間は何ですか。**

ワークロード全体を最もよく表す時間を選択することをお勧めします。 そうすることで、ワークロード内のすべてのクエリで分析が実行されます。

**Q: トレースキャプチャを開始する前に、データベースのバックアップを実行するにはどの程度重要ですか?**

トレースキャプチャを開始する前に、すべてのターゲットデータベースをバックアップしていることを確認してください。 ターゲット1とターゲット2でキャプチャされたトレースが再生されます。 データベースの状態が同じでない場合は、実験の結果がスキューされます。

**Q: トレースではなく Xevent を収集することはできますか。 Xevent を再生できますか。**

はい。 DEA は Xevent をサポートしています。 DEA の最新バージョンをダウンロードし、試してみてください。

## <a name="troubleshoot-trace-captures"></a>トレースキャプチャのトラブルシューティング

トレースキャプチャの実行中にエラーが発生した場合は、次のことを確認してください。

- SQL Server を実行しているコンピューターの名前が有効です。 確認するには、SQL Server Management Studio (SSMS) を使用して SQL Server を実行しているコンピューターに接続します。
- ファイアウォールの構成により、SQL Server を実行しているコンピューターへの接続がブロックされることはありません。
- ユーザーには、 [再生 FAQ](./database-experimentation-assistant-replay-trace.md?view=sql-server-ver15#frequently-asked-questions-about-trace-replay)に記載されているアクセス許可があります。
- トレース名は、標準のロールオーバー規則 (Capture 1) に従っていません \_ 。 代わりに、Capture 1a や Capture1 などのトレース名を試してください \_ 。

表示される可能性のあるエラーとその解決策を次に示します。

|考えられるエラー|ソリューション|  
|---|---|  
|ターゲット SQL Server でトレースを開始できません。必要なアクセス許可があるかどうか、および指定されたトレースファイルパスに対する書き込みアクセス権が SQL Server アカウントにあるかどうかを確認してください。 Sql エラーコード (53)|DEA ツールを実行するユーザーは、SQL Server を実行しているコンピューターにアクセスできる必要があります。 ユーザーに sysadmin ロールが割り当てられている必要があります。|  
|ターゲット SQL Server でトレースを開始できません。必要なアクセス許可があるかどうか、および指定されたトレースファイルパスに対する書き込みアクセス権が SQL Server アカウントにあるかどうかを確認してください。 Sql エラーコード (19062)|指定されたトレースパスが存在しないか、フォルダーに SQL Server サービスを実行しているアカウント (NETWORK SERVICE など) に対する書き込みアクセス許可がありません。 パスが存在し、トレースを開始するために必要なアクセス許可を持っている必要があります。|  
|現在、DEA トレースが対象サーバーで実行されています。|アクティブなトレースは、既に対象サーバーで実行されています。 サーバー全体のトレースが既に実行されている場合、新しいトレースを開始することはできません。|  
|キャプチャトレース用に要求されたデータベースを開くことができません。 このエラーは、データベース名が正しくないことが原因である可能性があります。|指定されたデータベースが存在しないか、現在のユーザーがアクセスできません。 正しいデータベース名を使用してください。|  

*Sql エラーコード*というラベルの他のエラーが表示された場合は、詳細な説明について[データベースエンジンエラー](../relational-databases/errors-events/database-engine-events-and-errors.md)を参照してください。

## <a name="see-also"></a>関連項目

- キャプチャしたトレースを再生する前に SQL Server の分散再生ツールを構成する方法については、 [Database Experimentation Assistant の分散再生の構成に関する](database-experimentation-assistant-configure-replay.md)ページを参照してください。